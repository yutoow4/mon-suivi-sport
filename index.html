<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#7c3aed">
    <title>Yutoow Fit Track</title>
    <link rel="icon" type="image/jpeg" href="logo.jpg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-firestore-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-auth-compat.min.js"></script>
    <style>
        * {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .glass-dark {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-hidden {
            transform: translateX(-50%) translateY(150%);
            opacity: 0;
        }

        .nav-visible {
            transform: translateX(-50%) translateY(0) scale(1);
            opacity: 1;
        }

        .nav-shrunk {
            transform: translateX(-50%) translateY(20%) scale(0.7);
            opacity: 0.7;
            pointer-events: none;
            /* Optional: prevent clicks when shrunk */
        }

        .timer-float {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 40;
        }

        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
            }

            50% {
                box-shadow: 0 0 40px rgba(255, 255, 255, 0.5);
            }
        }

        .pulse-glow {
            animation: pulse-glow 2s ease-in-out infinite;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"] {
            -moz-appearance: textfield;
        }

        .btn-glass {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-glass:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            filter: brightness(1.1);
        }

        .btn-glass:active {
            transform: translateY(0) scale(0.98);
            filter: brightness(0.95);
        }

        /* Smooth page transitions */
        .fade-in {
            animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
                filter: blur(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
                filter: blur(0);
            }
        }

        /* Smooth blur transitions */
        .blur-transition {
            transition: filter 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Modal Styles */
        .modal-overlay {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        /* --- THEMES --- */

        /* Dark Mode (Default) - Deep Mauve/Blue */
        body {
            background: linear-gradient(135deg, #1a1b2e 0%, #16213e 100%);
            color: white;
            /* Always white text for these deep themes */
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Light Mode (Original Base) - Purple Gradient */
        body.light-mode {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #1f2937;
            /* Default text color for light mode */
        }

        /* Adjust glass transparency for readability on different backgrounds */
        body.light-mode .glass {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            /* Keep original border for light mode glass */
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            /* Keep original shadow for light mode glass */
        }

        body .glass {
            background: rgba(255, 255, 255, 0.05);
            /* Slightly more transparent on dark */
        }

        body.light-mode .glass-dark {
            background: rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        /* Specific element adjustments */
        body.light-mode .bg-white\/5 {
            background-color: rgba(0, 0, 0, 0.05) !important;
        }

        body.light-mode .bg-white\/10 {
            background-color: rgba(0, 0, 0, 0.1) !important;
        }

        body.light-mode .bg-white\/20 {
            background-color: rgba(0, 0, 0, 0.15) !important;
        }

        body.light-mode .border-white\/20 {
            border-color: rgba(0, 0, 0, 0.1) !important;
        }

        body.light-mode input {
            color: #111827 !important;
        }

        /* Nav Icons in Light Mode */
        body.light-mode .nav-item svg.text-white {
            color: #7c3aed !important;
        }

        /* Active Purple */
        body.light-mode .nav-item span.text-white {
            color: #7c3aed !important;
        }

        /* Smooth transition for theme switch */
        body,
        .glass,
        .glass-dark,
        .text-white,
        button {
            transition: background-color 0.6s cubic-bezier(0.4, 0, 0.2, 1),
                color 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                filter 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Enhanced glass effect */
        .glass {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass:hover {
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
        }
    </style>
</head>

<body class="pb-32 transition-colors duration-500">
    <!-- Edit Modal -->
    <div id="edit-modal" class="fixed inset-0 z-[200] hidden items-center justify-center p-4 modal-overlay">
        <div class="glass glass-dark bg-black/80 rounded-3xl p-6 w-full max-w-sm space-y-4">
            <h3 id="modal-title" class="text-xl font-bold text-white">Éditer l'exercice</h3>

            <div class="space-y-3">
                <div>
                    <label class="text-white/60 text-xs block mb-1">Nom</label>
                    <input type="text" id="edit-name"
                        class="w-full bg-white/10 rounded-xl px-4 py-2 text-white border-0 outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="text-white/60 text-xs block mb-1">Focus / Muscle</label>
                    <input type="text" id="edit-focus"
                        class="w-full bg-white/10 rounded-xl px-4 py-2 text-white border-0 outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-white/60 text-xs block mb-1">Séries</label>
                        <input type="number" id="edit-sets"
                            class="w-full bg-white/10 rounded-xl px-4 py-2 text-white border-0 outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label class="text-white/60 text-xs block mb-1">Reps Cibles</label>
                        <input type="text" id="edit-reps"
                            class="w-full bg-white/10 rounded-xl px-4 py-2 text-white border-0 outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                </div>
                <div>
                    <label class="text-white/60 text-xs block mb-1">Repos (secondes)</label>
                    <input type="number" id="edit-rest"
                        class="w-full bg-white/10 rounded-xl px-4 py-2 text-white border-0 outline-none focus:ring-2 focus:ring-purple-500">
                </div>
            </div>

            <div class="flex gap-3 pt-2">
                <button onclick="closeEditModal()"
                    class="flex-1 py-3 rounded-xl bg-white/10 text-white font-semibold">Annuler</button>
                <button onclick="saveExerciseChanges()"
                    class="flex-1 py-3 rounded-xl bg-gradient-to-r from-purple-500 to-pink-500 text-white font-semibold shadow-lg">Sauvegarder</button>
            </div>
            <button onclick="deleteCurrentExercise()" class="w-full py-2 text-red-400 text-sm font-medium">Supprimer cet
                exercice</button>
        </div>
    </div>
    <div id="app" class="container mx-auto px-4 py-4 md:py-6 max-w-2xl">
        <!-- Header -->
        <!-- Header -->
        <div id="main-header" class="mb-6"></div>

        <!-- Main Content -->
        <div id="session-view" class="space-y-6"></div>
        <div id="profile-view" class="hidden space-y-6"></div>
        <div id="settings-view" class="hidden space-y-6"></div>
        <div id="auth-view" class="hidden space-y-6"></div>
    </div>

    <!-- Rest Timer (Floating) -->
    <div id="rest-timer"
        class="timer-float glass rounded-3xl px-6 py-4 hidden flex flex-col items-center gap-3 min-w-[200px]">
        <div class="text-center">
            <p class="text-white/70 text-xs mb-1">Repos</p>
            <p class="text-white text-4xl font-bold font-mono tracking-wider" id="timer-display">00:00</p>
        </div>
        <div class="flex gap-4 w-full justify-center">
            <button onclick="toggleTimer()" id="timer-toggle-btn"
                class="p-2 rounded-full bg-white/10 hover:bg-white/20 transition-all">
                <svg id="timer-icon-pause" class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <svg id="timer-icon-play" class="w-6 h-6 text-white hidden" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </button>
            <button onclick="stopRestTimer()"
                class="p-2 rounded-full bg-red-500/20 hover:bg-red-500/40 transition-all text-red-500">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="flex gap-2 w-full">
            <button onclick="adjustTimer(-10)"
                class="flex-1 py-3 rounded-xl bg-white/5 hover:bg-white/10 text-white font-semibold text-sm active:bg-white/20 touch-manipulation">-10s</button>
            <button onclick="adjustTimer(10)"
                class="flex-1 py-3 rounded-xl bg-white/5 hover:bg-white/10 text-white font-semibold text-sm active:bg-white/20 touch-manipulation">+10s</button>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav id="bottom-nav"
        class="fixed bottom-6 left-1/2 transform -translate-x-1/2 glass rounded-full px-6 py-3 flex items-center gap-8 transition-all duration-300 nav-visible z-50">
        <button onclick="switchView('session')" class="nav-item flex flex-col items-center gap-1 transition-all">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z">
                </path>
            </svg>
            <span class="text-white text-xs font-medium">Séance</span>
        </button>
        <button onclick="switchView('profile')" class="nav-item flex flex-col items-center gap-1 transition-all">
            <svg class="w-6 h-6 text-white/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
            <span class="text-white/60 text-xs font-medium">Profil</span>
        </button>
        <button onclick="switchView('settings')" class="nav-item flex flex-col items-center gap-1 transition-all">
            <svg class="w-6 h-6 text-white/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                </path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            <span class="text-white/60 text-xs font-medium">Paramètres</span>
        </button>
    </nav>

    <script>
        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyB5uqBRZFJRHlLeLhYbizGYYfEvE0qTbHc",
            authDomain: "yutoow-fit.firebaseapp.com",
            projectId: "yutoow-fit",
            storageBucket: "yutoow-fit.firebasestorage.app",
            messagingSenderId: "139731145452",
            appId: "1:139731145452:web:6d40d913cfcffbf92d4bc9",
            measurementId: "G-W1FZLQH0TS"
        };

        // Initialize Firebase
        let auth, db;
        let currentUser = null;

        try {
            if (firebaseConfig.apiKey !== "VOTRE_API_KEY") {
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();

                // Auth State Listener
                auth.onAuthStateChanged(user => {
                    currentUser = user;
                    console.log("Auth State Changed:", user ? user.email : "No User");
                    if (user) {
                        syncData(); // Sync on login
                    }
                    renderHeader(); // Update Header (User info)
                    renderProfile(); // Update Profile UI (Login btn vs User info)
                    renderSettings(); // Update Settings UI (Logout btn)
                });
            } else {
                console.warn("Firebase non configuré. Mode Offline uniquement.");
            }
        } catch (e) {
            console.error("Erreur init Firebase:", e);
        }

        // --- DATA STRUCTURES & STORAGE KEYS ---
        const STORAGE_KEY_SESSIONS = 'onair_sessions';
        const STORAGE_KEY_CURRENT_SESSION = 'onair_current_session';
        const STORAGE_KEY_PRS = 'onair_prs'; // Personal Records

        // Helper to get data
        function countSessions() {
            const sessions = JSON.parse(localStorage.getItem(STORAGE_KEY_SESSIONS) || '[]');
            return sessions.length;
        }

        function getSessions() {
            return JSON.parse(localStorage.getItem(STORAGE_KEY_SESSIONS) || '[]');
        }

        function saveSessionToHistory(session) {
            const sessions = getSessions();
            sessions.push(session);
            localStorage.setItem(STORAGE_KEY_SESSIONS, JSON.stringify(sessions));
            saveToCloud();
        }

        function getPRs() {
            return JSON.parse(localStorage.getItem(STORAGE_KEY_PRS) || '{}');
        }

        function updatePR(exerciseName, weight, reps) {
            const prs = getPRs();
            const currentPR = prs[exerciseName] || { weight: 0, reps: 0 };

            // Simple logic: Heavier weight OR same weight with more reps = New PR
            if (weight > currentPR.weight || (weight === currentPR.weight && reps > currentPR.reps)) {
                prs[exerciseName] = { weight, reps, date: new Date().toISOString() };
                localStorage.setItem(STORAGE_KEY_PRS, JSON.stringify(prs));
                saveToCloud();
                return true; // Is a new PR
            }
            return false;
        }

        function exportSessionToTxt(sessionId) {
            const sessions = getSessions();
            const session = sessions.find(s => s.id === sessionId);
            if (!session) {
                // If not found in history (rare case straight after save?), try to construct from args?
                // But it should be there. Let's add an alert if it fails.
                console.error("Session non trouvée pour l'export:", sessionId);
                alert("Erreur: Impossible de générer le fichier de la séance.");
                return;
            }

            const startDate = new Date(session.startTime);
            const endDate = new Date(session.endTime);
            const duration = Math.floor((endDate - startDate) / 60000);

            let content = `ON AIR TRACKING - RÉSUMÉ DE SÉANCE\n`;
            content += `--------------------------------\n`;
            content += `Programme: ${session.programName}\n`;
            content += `Date: ${startDate.toLocaleDateString('fr-FR')}\n`;
            content += `Heure: ${startDate.toLocaleTimeString('fr-FR')}\n`;
            content += `Durée: ${duration} minutes\n`;
            content += `--------------------------------\n\n`;

            if (session.details) {
                // Group by exercise to preserve order
                const setsByExercise = session.details.reduce((acc, set) => {
                    if (!acc[set.exercise]) acc[set.exercise] = [];
                    acc[set.exercise].push(set);
                    return acc;
                }, {});

                for (const [exercise, sets] of Object.entries(setsByExercise)) {
                    content += `### ${exercise}\n`;
                    sets.forEach((set, index) => {
                        content += `   Série ${index + 1}: ${set.weight}kg x ${set.reps}\n`;
                    });
                    content += `\n`;
                }
            } else {
                // Fallback
                for (const [exercise, data] of Object.entries(session.exercises)) {
                    content += `### ${exercise}\n`;
                    content += `   ${data.sets} séries | Total: ${data.totalWeight}kg | Total Reps: ${data.totalReps}\n\n`;
                }
            }

            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Seance_${session.programName}_${startDate.toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // --- APP LOGIC ---

        const STORAGE_KEY_PROGRAMS = 'onair_programs';

        let programs = {};

        // Default Programs (Initialize if LocalStorage empty)
        const defaultPrograms = {
            lundi: {
                id: 'lundi',
                name: "PUSH",
                exercises: [
                    { name: "Développé Couché", focus: "Pectoraux", sets: 4, reps: "8-10", rest: 120 },
                    { name: "Développé Incliné Haltères", focus: "Pectoraux Supérieurs", sets: 4, reps: "10-12", rest: 90 },
                    { name: "Écarté Poulie Haute", focus: "Pectoraux", sets: 3, reps: "12-15", rest: 60 },
                    { name: "Développé Militaire", focus: "Épaules", sets: 4, reps: "8-10", rest: 120 },
                    { name: "Élévations Latérales", focus: "Deltoïdes Latéraux", sets: 4, reps: "12-15", rest: 60 },
                    { name: "Extension Triceps Poulie", focus: "Triceps", sets: 3, reps: "12-15", rest: 60 },
                    { name: "Dips", focus: "Triceps/Pectoraux", sets: 3, reps: "8-12", rest: 90 }
                ]
            },
            mardi: {
                id: 'mardi',
                name: "PULL",
                exercises: [
                    { name: "Tirage Vertical Poulie Prise Neutre - Grand Dorsal", focus: "Largeur du dos", sets: 4, reps: "8-12", rest: 105 },
                    { name: "Tirage Horizontale Prise Neutre - Trapèzes, Rhomboïdes", focus: "Épaisseur, milieu du dos", sets: 3, reps: "10-12", rest: 90 },
                    { name: "Rowing Machine Unilatéral - Grand Dorsal et Bas du dos", focus: "Isolation et épaisseur", sets: 3, reps: "6-8 / bras", rest: 75 },
                    { name: "Bucheron Haltère - Grand Dorsal, Lombaires, Core", focus: "Rotation", sets: 3, reps: "6-8 / bras", rest: 90 },
                    { name: "Curl Marteau - Brachial et Longue Portion du Biceps", focus: "Épaisseur du bras", sets: 3, reps: "8-12", rest: 75 },
                    { name: "Curl Incliné - Longue Portion du Biceps", focus: "Pic du biceps, étirement maximal", sets: 3, reps: "10-12", rest: 75 }
                ]
            },
            mercredi: {
                id: 'mercredi',
                name: "LEGS",
                exercises: [
                    { name: "Leg Extension - Quadriceps", focus: "Isolation partie basse/externe", sets: 3, reps: "12-15", rest: 90 },
                    { name: "Presse Incliné - Quadriceps, Fessiers, Ischio-jambiers", focus: "Travail global", sets: 4, reps: "6-8", rest: 150 },
                    { name: "Hack Squat - Quadriceps", focus: "Accent vastes externes", sets: 3, reps: "10-12", rest: 105 },
                    { name: "Leg Curl Allongé / Assis - Ischio-jambiers", focus: "Isolation", sets: 3, reps: "10-12", rest: 75 },
                    { name: "Mollets Debout Haltères - Mollets", focus: "Gastrocnémien, Jumeaux", sets: 4, reps: "12-20", rest: 50 }
                ]
            },
            vendredi: {
                id: 'vendredi',
                name: "PUSH",
                exercises: [
                    { name: "Chest Press Couché - Faisceau Sternal", focus: "Milieu du pec", sets: 4, reps: "6-8", rest: 105 },
                    { name: "Développé Incliné Haltères - Faisceau Claviculaire", focus: "Haut du pec", sets: 3, reps: "8-12", rest: 90 },
                    { name: "PecFly - Faisceau Sternal et Étirement", focus: "Isolation", sets: 3, reps: "12-15", rest: 60 },
                    { name: "Développé Militaire Haltères - Faisceaux Antérieur et Moyen", focus: "Épaule", sets: 3, reps: "10-12", rest: 75 },
                    { name: "Élévations Latérales - Faisceau Moyen", focus: "Donne la largeur", sets: 4, reps: "12-20", rest: 50 },
                    { name: "Face Pulls - Faisceau Postérieur et Coiffe", focus: "Rotateurs", sets: 3, reps: "15-20", rest: 60 }
                ]
            },
            samedi: {
                id: 'samedi',
                name: "PULL",
                exercises: [
                    { name: "Tirage Vertical Prise Large - Grand Dorsal", focus: "Largeur du dos", sets: 4, reps: "8-12", rest: 105 },
                    { name: "Tirage Horizontal Prise Serrée - Trapèzes, Rhomboïdes, Grand Dorsal", focus: "Épaisseur", sets: 3, reps: "10-12", rest: 90 },
                    { name: "Hyperextensions (Dorsaux) - Érecteurs du Rachis", focus: "Bas du dos/lombaires", sets: 3, reps: "15-20", rest: 45 },
                    { name: "Curl Marteau - Brachial et Longue Portion du Biceps", focus: "Épaisseur bras", sets: 3, reps: "8-12", rest: 75 },
                    { name: "Coude Biceps - Biceps", focus: "Tension constante, chef long", sets: 3, reps: "12-15", rest: 60 }
                ]
            }
        };

        function loadPrograms() {
            const saved = localStorage.getItem(STORAGE_KEY_PROGRAMS);
            if (saved) {
                programs = JSON.parse(saved);
                // Ensure IDs exist (migration check)
                Object.keys(programs).forEach(key => {
                    if (!programs[key].id) programs[key].id = key;
                });
            } else {
                programs = defaultPrograms;
                savePrograms();
            }
        }

        function savePrograms() {
            localStorage.setItem(STORAGE_KEY_PROGRAMS, JSON.stringify(programs));
            saveToCloud();
        }

        // State
        let currentDay = 'lundi';
        let currentExerciseIndex = 0;
        let currentSetNumber = 1;
        let sessionData = [];
        let currentSessionId = null;
        let sessionStartTime = null;
        let timerInterval = null;
        let exerciseTimerInterval = null;
        let setTimerInterval = null;
        let timerRemaining = 0;
        let isTimerPaused = false;


        // Audio Context for sound effects
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        function playCompletionSound() {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            // Gentle notification sound (C major chord arpeggio)
            oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
            oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
            oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5

            oscillator.type = 'sine';
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        }

        // Initialize
        // Initial Render
        renderHeader();
        loadSession();
        setupScrollBehavior();

        // --- HEADER RENDERER ---
        function renderHeader() {
            const headerEl = document.getElementById('main-header');
            if (!headerEl) return;

            const isDark = !document.body.classList.contains('light-mode');

            headerEl.innerHTML = `
                <div class="glass rounded-3xl p-4 md:p-6 flex flex-col items-center text-center relative transition-all duration-500">
                    <!-- Status / Profile Link -->
                    ${currentUser ? `
                        <div onclick="switchView('profile')" class="absolute top-4 left-4 flex items-center gap-2 cursor-pointer opacity-70 hover:opacity-100 transition-opacity">
                            <div class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.5)]"></div>
                            <span class="text-white text-xs font-medium hidden md:block">Connecté</span>
                        </div>
                    ` : ''}

                    <!-- Theme Toggle -->
                    <button onclick="toggleTheme()"
                        class="absolute top-4 right-4 p-3 rounded-full bg-white/10 hover:bg-white/20 transition-all text-white/80 hover:text-white active:scale-95 touch-manipulation">
                        <svg class="w-6 h-6 ${isDark ? 'hidden' : ''}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                        <svg class="w-6 h-6 ${isDark ? '' : 'hidden'}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                        </svg>
                    </button>

                    <img src="logo.jpg" alt="Logo YF Tracker" class="h-12 w-auto mb-2 md:h-16 md:mb-4 rounded-xl shadow-lg">
                    <h1 class="text-2xl md:text-3xl font-bold text-white mb-1 md:mb-2">Yutoow Fit Track</h1>
                    <p class="text-white/70 text-sm">
                        ${currentUser ? `Bon retour, <span class="text-white font-semibold">${currentUser.email.split('@')[0]}</span> !` : 'Ton coach personnel de fitness'}
                    </p>
                </div>
            `;
        }

        // Hook theme toggle to re-render header icons properly
        const originalToggleTheme = toggleTheme;
        toggleTheme = function () {
            document.body.classList.toggle('light-mode');
            const isLight = document.body.classList.contains('light-mode');
            localStorage.setItem(STORAGE_KEY_THEME, isLight ? 'light' : 'dark');
            renderHeader(); // Refresh icons
        };

        function loadTheme() {
            const theme = localStorage.getItem('onair_theme');
            if (theme === 'light') {
                document.body.classList.add('light-mode');
            }
            updateThemeIcon();
        }

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const isLight = document.body.classList.contains('light-mode');
            localStorage.setItem('onair_theme', isLight ? 'light' : 'dark');
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const isLight = document.body.classList.contains('light-mode');
            const sun = document.getElementById('theme-icon-sun');
            const moon = document.getElementById('theme-icon-moon');

            if (isLight) {
                sun.classList.remove('hidden');
                moon.classList.add('hidden');
            } else {
                sun.classList.add('hidden');
                moon.classList.remove('hidden');
            }
        }


        function loadSession() {
            // Load fresh programs data
            loadPrograms();

            // Safety check if day deleted
            if (!programs[currentDay]) {
                const keys = Object.keys(programs);
                if (keys.length > 0) currentDay = keys[0];
                else {
                    // Handle case where all programs deleted? (Should prevent deleting last one)
                    programs = defaultPrograms;
                    savePrograms();
                    currentDay = 'lundi';
                }
            }

            const program = programs[currentDay];

            // Safety check for exercises
            if (!program.exercises || program.exercises.length === 0) {
                // Add dummy exercise if empty to prevent crash
                program.exercises = [{ name: "Nouvel Exercice", focus: "Muscle", sets: 3, reps: "10", rest: 60 }];
                savePrograms();
            }

            // Safety check for index
            if (currentExerciseIndex >= program.exercises.length) {
                currentExerciseIndex = 0;
            }

            const exercise = program.exercises[currentExerciseIndex];

            // Initialize session if first exercise
            if (currentExerciseIndex === 0 && sessionData.length === 0) {
                currentSessionId = Date.now().toString();
                exerciseStartTime = Date.now();
                setStartTime = Date.now();
            }

            renderExercise(exercise, program.name);

            // Pre-fill inputs with best Previous Performance (PR) logic or Last Session
            // Setting a small timeout to ensure DOM is ready
            setTimeout(() => {
                const prs = getPRs();
                const exerciseName = exercise.name;
                const weightInput = document.getElementById('weight-input');
                const repsInput = document.getElementById('reps-input');

                if (prs[exerciseName]) {
                    // Show previous best as placeholder
                    if (weightInput) weightInput.placeholder = `${prs[exerciseName].weight}`;
                    if (repsInput) repsInput.placeholder = `${prs[exerciseName].reps}`;

                    // Optional: pre-fill values to save time? Let's stick to placeholder for now 
                    // or user might accidentally log same weight.
                    // But user asked for "memory", usually means "what did I do last time?"
                    // Auto-fill makes it faster.
                    if (weightInput) weightInput.value = prs[exerciseName].weight;
                }
            }, 50);

            // Clear any existing timers
            if (exerciseTimerInterval) clearInterval(exerciseTimerInterval);
            if (setTimerInterval) clearInterval(setTimerInterval);
        }

        function renderExercise(exercise, programName) {
            const completedSets = sessionData.filter(s =>
                s.exercise === exercise.name
            ).length;

            const sessionView = document.getElementById('session-view');

            // Dynamic Day Selector
            let daysHtml = '<div class="grid grid-cols-2 lg:grid-cols-3 gap-3 mb-2">';
            const dayKeys = Object.keys(programs);
            dayKeys.forEach(key => {
                const prog = programs[key];
                // Capitalize first letter of key
                const displayKey = key.charAt(0).toUpperCase() + key.slice(1);
                const isSelected = currentDay === key;

                daysHtml += `
                    <button onclick="changeDay('${key}')"
                        class="${isSelected ? 'bg-white/20 ring-2 ring-purple-400/50' : 'bg-white/5'} rounded-2xl py-3 px-2 text-white text-sm font-semibold transition-all btn-glass flex flex-col items-center justify-center relative group min-h-[60px] touch-manipulation">
                        <span>${displayKey} - ${prog.name}</span>
                        ${isSelected && dayKeys.length > 1 ? `<span onclick="event.stopPropagation(); deleteDay('${key}')" class="absolute -top-2 -right-2 bg-red-500 rounded-full w-6 h-6 text-xs flex items-center justify-center shadow-lg active:scale-90 transition-transform cursor-pointer z-10 font-bold">×</span>` : ''}
                    </button>
                    `;
            });
            daysHtml += `
                    <button onclick="addNewDay()" class="bg-white/5 border border-dashed border-white/30 rounded-2xl py-3 text-white/50 text-sm font-semibold hover:bg-white/10 transition-all flex items-center justify-center gap-2" >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                </button>
            </div>`;


            sessionView.innerHTML = `
                <!-- Day Selector -->
                <div class="glass rounded-3xl p-4 space-y-3">
                    ${daysHtml}
                    <!-- Edit Program Name Btn -->
                    <button onclick="renameCurrentDay()" class="w-full text-center text-xs text-white/40 hover:text-white/80 transition-colors">
                        Modifier le nom du programme (${programName})
                    </button>
                </div>

                <!-- Progress -->
                <div class="glass rounded-3xl p-6">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-white/70 text-sm">Progression</span>
                        <span class="text-white font-semibold">${currentExerciseIndex + 1}/${programs[currentDay].exercises.length}</span>
                    </div>
                    <div class="w-full bg-white/10 rounded-full h-3 overflow-hidden">
                        <div class="bg-gradient-to-r from-purple-400 to-pink-400 h-full rounded-full transition-all duration-500" 
                             style="width: ${((currentExerciseIndex) / programs[currentDay].exercises.length) * 100}%"></div>
                    </div>
                </div>

                <!-- Current Exercise -->
                <div class="glass rounded-3xl p-6 md:p-8 relative group">
                    <!-- Edit Button -->
                    <button onclick="openEditModal()" class="absolute top-3 right-3 p-3 rounded-full bg-white/10 hover:bg-white/20 text-white/70 hover:text-white transition-all active:scale-95 touch-manipulation">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                        </svg>
                    </button>

                    <div class="flex items-center justify-between mb-6">
                        <button onclick="prevExercise()" class="p-3 rounded-full bg-white/5 hover:bg-white/10 text-white/70 hover:text-white transition-all active:scale-95 ${currentExerciseIndex === 0 ? 'opacity-0 pointer-events-none' : ''}">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        </button>
                        
                        <div class="text-center flex-1 px-2">
                            <p class="text-white/70 text-sm mb-1">${programName}</p>
                            <h2 class="text-2xl md:text-3xl font-bold text-white mb-1 leading-tight">${exercise.name}</h2>
                            <p class="text-white/80 text-sm">${exercise.focus}</p>
                        </div>

                        <button onclick="nextExercise()" class="p-3 rounded-full bg-white/5 hover:bg-white/10 text-white/70 hover:text-white transition-all active:scale-95 ${currentExerciseIndex === programs[currentDay].exercises.length - 1 ? 'opacity-0 pointer-events-none' : ''}">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                    </div>

                    <!-- Exercise Info -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="glass-dark rounded-2xl p-4 text-center">
                            <p class="text-white/70 text-xs mb-1">Séries</p>
                            <p class="text-white text-2xl font-bold">${completedSets}/${exercise.sets}</p>
                        </div>
                        <div class="glass-dark rounded-2xl p-4 text-center">
                            <p class="text-white/70 text-xs mb-1">Reps Cibles</p>
                            <p class="text-white text-2xl font-bold">${exercise.reps}</p>
                        </div>
                    </div>
                    


                    <!-- Set Input -->
                    <div class="space-y-4 mb-6">
                        <div>
                            <label class="text-white/70 text-sm mb-2 block">Poids (kg)</label>
                            <input type="number" id="weight-input" 
                                   class="w-full glass-dark rounded-2xl px-6 py-4 text-white text-2xl font-bold text-center border-0 focus:outline-none focus:ring-2 focus:ring-white/30"
                                   placeholder="0" step="0.5" min="0">
                        </div>
                        <div>
                            <label class="text-white/70 text-sm mb-2 block">Répétitions</label>
                            <input type="number" id="reps-input" 
                                   class="w-full glass-dark rounded-2xl px-6 py-4 text-white text-2xl font-bold text-center border-0 focus:outline-none focus:ring-2 focus:ring-white/30"
                                   placeholder="0" min="0">
                        </div>
                    </div>

                    <!-- Action Button -->
                    <button onclick="logSet()" 
                            class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-4 md:py-5 rounded-2xl hover:shadow-2xl transition-all btn-glass pulse-glow mb-4 text-lg">
                        Enregistrer Série ${completedSets + 1}
                    </button>
                    
                    <button onclick="addNewExercise()" class="w-full py-3 rounded-2xl border-2 border-dashed border-white/20 text-white/50 hover:text-white hover:border-white/40 hover:bg-white/5 transition-all text-sm font-semibold">
                        + Ajouter un exercice
                    </button>
                </div>

                <!--Completed Sets-- >
                    ${completedSets > 0 ? `
                <div class="glass rounded-3xl p-6">
                    <h3 class="text-white font-semibold mb-4">Séries Complétées</h3>
                    <div class="space-y-3">
                        ${sessionData.filter(s => s.exercise === exercise.name).map((set, i) => `
                            <div class="glass-dark rounded-2xl p-4 flex justify-between items-center">
                                <span class="text-white/70">Série ${i + 1}</span>
                                <span class="text-white font-semibold">${set.weight}kg × ${set.reps} reps</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''
                }
                `;
        }

        function logSet() {
            const weight = parseFloat(document.getElementById('weight-input').value);
            const reps = parseInt(document.getElementById('reps-input').value);

            if (!weight || !reps) {
                alert('Veuillez remplir le poids et les répétitions');
                return;
            }

            const exercise = programs[currentDay].exercises[currentExerciseIndex];

            const setData = {
                sessionId: currentSessionId,
                day: currentDay,
                programName: programs[currentDay].name,
                exercise: exercise.name,
                weight: weight,
                reps: reps,
                timestamp: new Date().toISOString()
            };

            sessionData.push(setData);

            // Save temporary state to LocalStorage (Crash recovery)
            localStorage.setItem(STORAGE_KEY_CURRENT_SESSION, JSON.stringify({
                id: currentSessionId,
                startTime: sessionStartTime,
                data: sessionData,
                day: currentDay,
                exerciseIndex: currentExerciseIndex,
                set: currentSetNumber
            }));
            saveToCloud();

            // Check for PR
            const isNewPr = updatePR(exercise.name, weight, reps);
            if (isNewPr) {
                // Visual feedback for PR could be added here
                // For now, maybe a small toast or just console
                console.log("NEW PR!");
            }

            // Clear inputs
            document.getElementById('weight-input').value = weight; // Keep weight for next set
            document.getElementById('reps-input').value = '';

            // Reset set timer - Not needed anymore as we don't track set duration visually
            // setStartTime = Date.now();

            // Check if all sets completed
            const completedSets = sessionData.filter(s => s.exercise === exercise.name).length;

            if (completedSets >= exercise.sets) {
                // Move to next exercise
                if (currentExerciseIndex < programs[currentDay].exercises.length - 1) {
                    currentExerciseIndex++;
                    currentSetNumber = 1;
                    loadSession();
                } else {
                    // Session complete
                    showSessionComplete();
                }
            } else {
                currentSetNumber++;
                loadSession();
            }

            // Start rest timer
            startRestTimer(exercise.rest);
        }

        function startRestTimer(seconds) {
            const timerEl = document.getElementById('rest-timer');
            timerEl.classList.remove('hidden');
            timerEl.classList.add('flex'); // Ensure flex display

            timerRemaining = seconds;
            isTimerPaused = false;
            updateTimerControls();
            updateTimerDisplay();

            clearInterval(timerInterval);
            timerInterval = setInterval(tickTimer, 1000);
        }

        function tickTimer() {
            if (!isTimerPaused) {
                timerRemaining--;
                updateTimerDisplay();

                if (timerRemaining <= 0) {
                    stopRestTimer(true);
                }
            }
        }

        function toggleTimer() {
            isTimerPaused = !isTimerPaused;
            updateTimerControls();
        }

        function adjustTimer(seconds) {
            timerRemaining += seconds;
            if (timerRemaining < 0) timerRemaining = 0;
            updateTimerDisplay();
        }

        function stopRestTimer(finished = false) {
            clearInterval(timerInterval);
            const timerEl = document.getElementById('rest-timer');

            if (finished) {
                playCompletionSound();
                // Flash effect or similar could go here
            }

            timerEl.classList.add('hidden');
            timerEl.classList.remove('flex');
        }

        function updateTimerDisplay() {
            const displayEl = document.getElementById('timer-display');
            const mins = Math.floor(timerRemaining / 60);
            const secs = timerRemaining % 60;
            displayEl.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')} `;
        }

        function updateTimerControls() {
            const pauseIcon = document.getElementById('timer-icon-pause');
            const playIcon = document.getElementById('timer-icon-play');

            if (isTimerPaused) {
                pauseIcon.classList.add('hidden');
                playIcon.classList.remove('hidden');
            } else {
                pauseIcon.classList.remove('hidden');
                playIcon.classList.add('hidden');
            }
        }

        // --- EXERCISE EDITING LOGIC ---

        function openEditModal() {
            const exercise = programs[currentDay].exercises[currentExerciseIndex];

            document.getElementById('edit-name').value = exercise.name;
            document.getElementById('edit-focus').value = exercise.focus;
            document.getElementById('edit-sets').value = exercise.sets;
            document.getElementById('edit-reps').value = exercise.reps;
            document.getElementById('edit-rest').value = exercise.rest;

            const modal = document.getElementById('edit-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeEditModal() {
            const modal = document.getElementById('edit-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function saveExerciseChanges() {
            const name = document.getElementById('edit-name').value;
            const focus = document.getElementById('edit-focus').value;
            const sets = parseInt(document.getElementById('edit-sets').value);
            const reps = document.getElementById('edit-reps').value;
            const rest = parseInt(document.getElementById('edit-rest').value);

            if (!name || isNaN(sets) || !reps || isNaN(rest)) {
                alert("Veuillez remplir correctement tous les champs.");
                return;
            }

            // Update data
            programs[currentDay].exercises[currentExerciseIndex] = {
                name, focus, sets, reps, rest
            };
            savePrograms();
            closeEditModal();
            loadSession(); // Re-render
        }

        function deleteCurrentExercise() {
            if (!confirm("Êtes-vous sûr de vouloir supprimer cet exercice ?")) return;

            programs[currentDay].exercises.splice(currentExerciseIndex, 1);
            savePrograms();
            closeEditModal();

            // Adjust index if needed
            if (currentExerciseIndex >= programs[currentDay].exercises.length) {
                currentExerciseIndex = Math.max(0, programs[currentDay].exercises.length - 1);
            }
            loadSession();
        }

        function addNewExercise() {
            const newExo = {
                name: "Nouvel Exercice",
                focus: "Muscle Cible",
                sets: 3,
                reps: "10-12",
                rest: 60
            };
            programs[currentDay].exercises.push(newExo);
            savePrograms();
            // Go to new exercise
            currentExerciseIndex = programs[currentDay].exercises.length - 1;
            loadSession();
            openEditModal(); // Let user edit immediately
        }

        function addNewDay() {
            const id = prompt("Identifiant du jour (ex: jeudi) sans accents/espaces si possible :");
            if (!id) return;
            const safeId = id.toLowerCase().replace(/[^a-z0-9]/g, '');
            if (!safeId) return;

            if (programs[safeId]) {
                alert("Ce jour existe déjà !");
                return;
            }

            const name = prompt("Nom du programme (ex: PUSH B) :");
            if (!name) return;

            programs[safeId] = {
                id: safeId,
                name: name,
                exercises: [
                    { name: "Exercice 1", focus: "Muscle", sets: 3, reps: "10", rest: 60 }
                ]
            };
            savePrograms();
            changeDay(safeId);
        }

        function deleteDay(key) {
            if (Object.keys(programs).length <= 1) {
                alert("Vous devez garder au moins un jour.");
                return;
            }
            if (!confirm(`Supprimer le programme ${programs[key].name} ?`)) return;

            delete programs[key];
            savePrograms();

            // Switch to a safe day
            const keys = Object.keys(programs);
            changeDay(keys[0]);
        }

        function renameCurrentDay() {
            const newName = prompt("Nouveau nom pour ce programme :", programs[currentDay].name);
            if (newName) {
                programs[currentDay].name = newName;
                savePrograms();
                loadSession();
            }
        }

        function changeDay(day) {
            currentDay = day;
            currentExerciseIndex = 0;
            currentSetNumber = 1;
            // Reset state
            currentSessionId = null;
            sessionStartTime = null;
            sessionData = [];
            currentExerciseIndex = 0;
            currentSetNumber = 1;

            // Sync to cloud
            saveToCloud();

            // Refresh view
            switchView('session');
            loadSession();
        }

        function prevExercise() {
            if (currentExerciseIndex > 0) {
                currentExerciseIndex--;
                loadSession();
            }
        }

        function nextExercise() {
            if (currentExerciseIndex < programs[currentDay].exercises.length - 1) {
                currentExerciseIndex++;
                loadSession();
            }
        }

        function showSessionComplete() {
            // Ensure sessionStartTime is a valid Date object or string
            let startTimeIso = new Date().toISOString();
            if (sessionStartTime) {
                startTimeIso = (sessionStartTime instanceof Date) ? sessionStartTime.toISOString() : new Date(sessionStartTime).toISOString();
            }

            // Save complete session summary
            const sessionSummary = {
                id: currentSessionId,
                day: currentDay,
                programName: programs[currentDay].name,
                startTime: startTimeIso,
                endTime: new Date().toISOString(),
                totalExercises: programs[currentDay].exercises.length,
                totalSets: sessionData.length,
                details: sessionData,
                exercises: sessionData.reduce((acc, set) => {
                    if (!acc[set.exercise]) {
                        acc[set.exercise] = { sets: 0, totalWeight: 0, totalReps: 0 };
                    }
                    acc[set.exercise].sets++;
                    acc[set.exercise].totalWeight += set.weight;
                    acc[set.exercise].totalReps += set.reps;
                    return acc;
                }, {})
            };

            // Save to LocalStorage History
            saveSessionToHistory(sessionSummary);

            // Auto-Export to .txt
            // Small delay to ensure UI updates first if needed, but mainly to separate actions
            setTimeout(() => {
                exportSessionToTxt(currentSessionId);
            }, 500);

            // Clear current session temp data
            localStorage.removeItem(STORAGE_KEY_CURRENT_SESSION);

            const sessionView = document.getElementById('session-view');
            sessionView.innerHTML = `
                    < div class="glass rounded-3xl p-12 text-center" >
                    <div class="text-6xl mb-6">🎉</div>
                    <h2 class="text-3xl font-bold text-white mb-4">Séance Terminée !</h2>
                    <p class="text-white/70 mb-8">Excellent travail ! Tu as complété tous les exercices.</p>
                    <div class="flex flex-col gap-4">
                        <button onclick="resetSession()" 
                                class="bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-4 px-8 rounded-2xl btn-glass w-full">
                            Nouvelle Séance
                        </button>
                        <button onclick="exportSessionToTxt('${currentSessionId}')" 
                                class="bg-white/10 text-white font-bold py-4 px-8 rounded-2xl btn-glass w-full flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            Exporter en Bloc Note
                        </button>
                    </div>
                </div >
                    `;
        }

        function resetSession() {
            currentExerciseIndex = 0;
            currentSetNumber = 1;
            sessionData = [];
            currentSessionId = null;
            sessionStartTime = null;
            loadSession();
        }

        function switchView(view) {
            document.getElementById('session-view').classList.add('hidden');
            document.getElementById('profile-view').classList.add('hidden');
            document.getElementById('settings-view').classList.add('hidden');

            if (view === 'session') {
                document.getElementById('session-view').classList.remove('hidden');
            } else if (view === 'profile') {
                document.getElementById('profile-view').classList.remove('hidden');
                renderProfile();
            } else if (view === 'settings') {
                document.getElementById('settings-view').classList.remove('hidden');
                renderSettings();
            } else if (view === 'auth') {
                document.getElementById('auth-view').classList.remove('hidden');
                renderAuth();
            }

            // Update nav icons
            document.querySelectorAll('.nav-item').forEach((item, i) => {
                const svg = item.querySelector('svg');
                const span = item.querySelector('span');
                const isActive = (view === 'session' && i === 0) ||
                    (view === 'profile' && i === 1) ||
                    (view === 'settings' && i === 2);

                svg.classList.toggle('text-white', isActive);
                svg.classList.toggle('text-white/60', !isActive);
                span.classList.toggle('text-white', isActive);
                span.classList.toggle('text-white/60', !isActive);
            });
        }

        function renderProfile() {
            const sessions = getSessions().sort((a, b) => new Date(b.startTime) - new Date(a.startTime));
            const prs = getPRs();

            const profileView = document.getElementById('profile-view');

            // --- AUTH SECTION IN PROFILE ---
            let authHtml = '';
            if (!currentUser && firebaseConfig.apiKey !== "VOTRE_API_KEY") {
                authHtml = `
                    <div class="glass rounded-3xl p-6 mb-6 flex flex-col items-center text-center">
                        <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center mb-4 shadow-lg">
                            <svg class="w-8 h-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                        </div>
                        <h3 class="text-white font-bold text-lg mb-1">Sauvegardez votre progression</h3>
                        <p class="text-white/60 text-sm mb-4">Créez un compte pour ne jamais perdre vos séances et y accéder partout.</p>
                        <button onclick="switchView('auth')" class="w-full bg-white text-purple-900 font-bold py-3 rounded-xl hover:bg-white/90 transition-all">
                            Se connecter / S'inscrire
                        </button>
                    </div>
                 `;
            } else if (currentUser) {
                authHtml = `
                    <div class="glass rounded-3xl p-6 mb-6 flex items-center gap-4">
                        <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center shadow-lg">
                            <svg class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                        </div>
                        <div>
                            <p class="text-white/60 text-xs uppercase tracking-wider font-semibold">Connecté en tant que</p>
                            <p class="text-white font-bold truncate max-w-[200px]">${currentUser.email}</p>
                        </div>
                    </div>
                `;
            }

            let prHtml = '';
            const prKeys = Object.keys(prs);
            if (prKeys.length > 0) {
                prHtml = `
                    < div class="glass rounded-3xl p-6 mb-6" >
                         <h2 class="text-xl font-bold text-white mb-4">🏆 Mes Records (PR)</h2>
                         <div class="space-y-3">
                            ${prKeys.map(key => `
                                <div class="glass-dark rounded-xl p-3 flex justify-between items-center">
                                    <span class="text-white text-sm font-medium">${key}</span>
                                    <span class="text-yellow-400 font-bold">${prs[key].weight}kg <span class="text-xs text-white/50">x${prs[key].reps}</span></span>
                                </div>
                            `).join('')}
                         </div>
                    </div >
                    `;
            }

            if (sessions.length === 0) {
                profileView.innerHTML = `
                    < div class="glass rounded-3xl p-8 text-center" >
                        <div class="w-24 h-24 mx-auto mb-4 glass-dark rounded-full flex items-center justify-center">
                            <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                        <h2 class="text-2xl font-bold text-white mb-2">Profil Athlète</h2>
                        <p class="text-white/70 mb-6">Aucune séance enregistrée pour le moment</p>
                        <button onclick="switchView('session')" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-3 px-6 rounded-2xl btn-glass">
                            Commencer une séance
                        </button>
                    </div >
                    `;
                return;
            }

            profileView.innerHTML = `
                    < div class="glass rounded-3xl p-6 mb-6" >
                    <h2 class="text-2xl font-bold text-white mb-2">Mes Séances</h2>
                    <p class="text-white/70 text-sm">${sessions.length} séance${sessions.length > 1 ? 's' : ''} enregistrée${sessions.length > 1 ? 's' : ''}</p>
                </div >

                    ${prHtml}

                <div class="space-y-4">
                    ${sessions.map(session => {
                const startDate = new Date(session.startTime);
                const endDate = new Date(session.endTime);
                const duration = Math.floor((endDate - startDate) / 60000); // minutes

                // Get muscle groups based on program
                const muscleGroups = {
                    'PUSH': '💪 Pectoraux / Épaules / Triceps',
                    'PULL': '🏋️ Dorsaux / Biceps / Trapèzes',
                    'LEGS': '🦵 Quadriceps / Ischio-jambiers / Mollets'
                };

                return `
                                    <div class="glass rounded-3xl p-6 cursor-pointer hover:bg-white/5 transition-all" onclick="showSessionDetail('${session.id}')">
                                        <div class="flex justify-between items-start mb-4">
                                            <div>
                                                <h3 class="text-xl font-bold text-white mb-1">${session.programName}</h3>
                                                <p class="text-white/60 text-sm">${muscleGroups[session.programName] || session.programName}</p>
                                            </div>
                                            <span class="glass-dark px-3 py-1 rounded-full text-white text-xs font-semibold">
                                                ${duration} min
                                            </span>
                                        </div>
                                        
                                        <div class="flex items-center gap-4 mb-4 text-white/70 text-sm">
                                            <div class="flex items-center gap-2">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                                </svg>
                                                ${startDate.toLocaleDateString('fr-FR')}
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                </svg>
                                                ${startDate.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}
                                            </div>
                                        </div>
                                        
                                        <div class="grid grid-cols-3 gap-3">
                                            <div class="glass-dark rounded-xl p-3 text-center">
                                                <p class="text-white/60 text-xs mb-1">Exercices</p>
                                                <p class="text-white font-bold">${session.totalExercises}</p>
                                            </div>
                                            <div class="glass-dark rounded-xl p-3 text-center">
                                                <p class="text-white/60 text-xs mb-1">Séries</p>
                                                <p class="text-white font-bold">${session.totalSets}</p>
                                            </div>
                                            <div class="glass-dark rounded-xl p-3 text-center">
                                                <p class="text-white/60 text-xs mb-1">Volume</p>
                                                <p class="text-white font-bold">${Object.values(session.exercises).reduce((sum, ex) => sum + ex.totalWeight, 0).toFixed(0)}kg</p>
                                            </div>
                                        </div>
                                    </div>
                                `;
            }).join('')}
                </div>
                `;
        }

        function showSessionDetail(sessionId) {
            const sessions = getSessions();
            const session = sessions.find(s => s.id === sessionId);

            if (!session) return;

            const startDate = new Date(session.startTime);
            const endDate = new Date(session.endTime);
            const duration = Math.floor((endDate - startDate) / 60000);

            const profileView = document.getElementById('profile-view');
            profileView.innerHTML = `
                    < div class="glass rounded-3xl p-6 mb-6" >
                    <div class="flex justify-between items-center mb-4">
                        <button onclick="renderProfile()" class="flex items-center gap-2 text-white/70 hover:text-white transition-all">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                            Retour
                        </button>
                        <button onclick="exportSessionToTxt('${session.id}')" class="p-2 bg-white/10 rounded-full hover:bg-white/20 transition-all text-white">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                        </button>
                    </div>
                    <h2 class="text-2xl font-bold text-white mb-2">${session.programName}</h2>
                    <p class="text-white/70 text-sm">${startDate.toLocaleDateString('fr-FR')} à ${startDate.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}</p>
                </div >
                
                <div class="glass rounded-3xl p-6 mb-6">
                    <div class="grid grid-cols-3 gap-4">
                        <div class="text-center">
                            <p class="text-white/60 text-sm mb-1">Durée</p>
                            <p class="text-white text-2xl font-bold">${duration} min</p>
                        </div>
                        <div class="text-center">
                            <p class="text-white/60 text-sm mb-1">Exercices</p>
                             <p class="text-white text-2xl font-bold">${session.totalExercises}</p>
                        </div>
                        <div class="text-center">
                            <p class="text-white/60 text-sm mb-1">Séries</p>
                            <p class="text-white text-2xl font-bold">${session.totalSets}</p>
                        </div>
                    </div>
                </div>
                
                <div class="glass rounded-3xl p-6">
                    <h3 class="text-white font-semibold mb-4">Détails des Exercices</h3>
                    <div class="space-y-3">
                        ${Object.entries(session.exercises).map(([exerciseName, data]) => `
                            <div class="glass-dark rounded-2xl p-4">
                                <p class="text-white font-semibold mb-2">${exerciseName}</p>
                                <div class="flex gap-4 text-sm text-white/70">
                                    <span>${data.sets} séries</span>
                                    <span>•</span>
                                    <span>${data.totalReps} reps total</span>
                                    <span>•</span>
                                    <span>${data.totalWeight.toFixed(1)}kg total</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                `;
        }

        function renderSettings() {
            document.getElementById('settings-view').innerHTML = `
                    < div class="glass rounded-3xl p-8" >
                    <h2 class="text-2xl font-bold text-white mb-6">Paramètres</h2>
                    <div class="space-y-6">
                        ${currentUser ? `
                        <div class="glass-dark rounded-2xl p-4 border border-green-500/30">
                             <p class="text-white font-bold mb-2">Compte</p>
                             <p class="text-white/70 text-sm mb-3">${currentUser.email}</p>
                             <button onclick="handleLogout()" class="text-red-400 text-sm font-semibold hover:text-white transition-colors">Déconnexion</button>
                        </div>` : ''}

                        <div class="glass-dark rounded-2xl p-4">
                            <p class="text-white font-semibold mb-2">À propos</p>
                            <p class="text-white/70 text-sm">Yutoow Fit Track v1.1</p>
                            <p class="text-white/50 text-xs">Développé pour l'excellence.</p>
                        </div>
                        
                        <div class="glass-dark rounded-2xl p-4 border border-red-500/30">
                            <p class="text-red-400 font-bold mb-4 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                                Zone de Danger
                            </p>
                            
                            <button onclick="clearHistory()" class="w-full bg-red-500/10 hover:bg-red-500/20 text-red-200 text-sm font-semibold py-3 px-4 rounded-xl transition-all mb-3 text-left flex justify-between items-center group">
                                Effacer l'historique des séances
                                <svg class="w-4 h-4 opacity-50 group-hover:opacity-100" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                            
                            <button onclick="resetApp()" class="w-full bg-red-600 hover:bg-red-700 text-white text-sm font-bold py-3 px-4 rounded-xl transition-all text-left flex justify-between items-center shadow-lg">
                                Réinitialiser TOUTE l'application
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                            </button>
                            <p class="text-white/40 text-xs mt-2">Attention: Réinitialiser supprime vos programmes personnalisés, vos PRs et tout l'historique.</p>
                        </div>
                    </div>
                </div >
            `;
        }

        function clearHistory() {
            if (confirm("Voulez-vous vraiment effacer l'historique de toutes vos séances passées ? Cette action est irréversible.")) {
                localStorage.removeItem(STORAGE_KEY_SESSIONS);
                alert("Historique effacé.");
                renderSettings();
            }
        }

        function resetApp() {
            if (confirm("ATTENTION : Cela va tout effacer (Séances, Records, Programmes personnalisés). L'application repartira à zéro. Continuer ?")) {
                if (confirm("Êtes-vous vraiment sûr ?")) {
                    localStorage.clear();
                    location.reload();
                }
            }
        }

        // --- AUTH FUNCTIONS ---

        function renderAuth() {
            document.getElementById('auth-view').innerHTML = `
                <div class="glass rounded-3xl p-8 max-w-sm mx-auto">
                    <h2 class="text-2xl font-bold text-white mb-6 text-center">Connexion</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="text-white/60 text-xs block mb-1">Email</label>
                            <input type="email" id="auth-email" class="w-full bg-white/10 rounded-xl px-4 py-3 text-white border-0 outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="text-white/60 text-xs block mb-1">Mot de passe</label>
                            <input type="password" id="auth-password" class="w-full bg-white/10 rounded-xl px-4 py-3 text-white border-0 outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 gap-3 mt-6">
                        <button onclick="handleLogin()" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-3 rounded-xl btn-glass shadow-lg">
                            Se connecter
                        </button>
                        <button onclick="handleSignup()" class="w-full bg-white/10 text-white font-semibold py-3 rounded-xl hover:bg-white/20 transition-all">
                            Créer un compte
                        </button>
                    </div>

                    <button onclick="switchView('profile')" class="w-full mt-4 text-white/50 text-sm hover:text-white transition-colors">
                        Retour
                    </button>
                    
                    <p id="auth-error" class="text-red-400 text-sm text-center mt-4 hidden"></p>
                </div>
            `;
        }

        async function handleLogin() {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const errorEl = document.getElementById('auth-error');

            try {
                errorEl.classList.add('hidden');
                await auth.signInWithEmailAndPassword(email, password);
                switchView('profile');
            } catch (error) {
                errorEl.textContent = "Erreur: " + error.message;
                errorEl.classList.remove('hidden');
            }
        }

        async function handleSignup() {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const errorEl = document.getElementById('auth-error');

            try {
                errorEl.classList.add('hidden');
                await auth.createUserWithEmailAndPassword(email, password);
                // On signup, push local data to cloud immediately if cloud is empty
                await saveToCloud(true);
                switchView('profile');
            } catch (error) {
                errorEl.textContent = "Erreur: " + error.message;
                errorEl.classList.remove('hidden');
            }
        }

        async function handleLogout() {
            await auth.signOut();
            switchView('profile');
        }

        // --- CLOUD SYNC FUNCTIONS ---

        async function syncData() {
            if (!currentUser || !db) return;

            const docRef = db.collection('users').doc(currentUser.uid);

            try {
                const doc = await docRef.get();
                if (doc.exists) {
                    const data = doc.data();
                    console.log("Cloud data found:", data);

                    // Simple Strategy: Cloud overwrites Local on Login (prevents data loss if phone broke)
                    // But if Cloud is old and Local is new? ideally merge. 
                    // For MVP: We assume Cloud is Truth. 

                    if (data.programs) {
                        programs = JSON.parse(data.programs);
                        savePrograms(); // saves to localStorage
                    }

                    if (data.sessions) {
                        localStorage.setItem(STORAGE_KEY_SESSIONS, data.sessions);
                    }

                    if (data.prs) {
                        localStorage.setItem(STORAGE_KEY_PRS, data.prs);
                    }

                    // Force UI refresh
                    loadSession();
                    console.log("Data synced from Cloud.");
                } else {
                    console.log("No cloud data. Uploading local.");
                    await saveToCloud();
                }
            } catch (error) {
                console.error("Sync error:", error);
            }
        }

        async function saveToCloud(force = false) {
            if (!currentUser || !db) return;

            const dataToSave = {
                programs: JSON.stringify(programs),
                sessions: localStorage.getItem(STORAGE_KEY_SESSIONS) || "[]",
                prs: localStorage.getItem(STORAGE_KEY_PRS) || "{}",
                lastUpdate: new Date().toISOString()
            };

            try {
                await db.collection('users').doc(currentUser.uid).set(dataToSave, { merge: true });
                console.log("Data saved to Cloud.");
            } catch (error) {
                console.error("Save to cloud error:", error);
            }
        }

        // Hook saveData to also push to cloud
        const originalSavePrograms = savePrograms;
        savePrograms = function () {
            originalSavePrograms(); // original local save
            saveToCloud();
        };

        const originalUpdatePR = updatePR;
        updatePR = function (exerciseName, weight, reps) {
            originalUpdatePR(exerciseName, weight, reps);
            saveToCloud();
        };

        // Note: saveSession() calls regular localStorage save. We should hook that too.
        // But saveSession isn't a global function to easily hook in this scope structure without refactor.
        // Instead, we will search for where sessions are saved.
        // It happens in showSessionComplete -> we can add a call there.

        function setupScrollBehavior() {
            let scrollTimeout;

            window.addEventListener('scroll', () => {
                const nav = document.getElementById('bottom-nav');
                const currentScrollTop = window.pageYOffset || document.documentElement.scrollTop;

                clearTimeout(scrollTimeout);

                if (currentScrollTop > lastScrollTop && currentScrollTop > 50) {
                    nav.classList.remove('nav-visible');
                    nav.classList.add('nav-shrunk');
                } else {
                    nav.classList.remove('nav-shrunk');
                    nav.classList.add('nav-visible');
                }

                scrollTimeout = setTimeout(() => {
                    nav.classList.remove('nav-shrunk');
                    nav.classList.add('nav-visible');
                }, 1500); // Auto-show after 1.5s of no scrolling

                lastScrollTop = currentScrollTop <= 0 ? 0 : currentScrollTop;
            });
        }
    </script>
</body>

</html>