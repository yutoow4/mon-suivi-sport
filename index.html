<!DOCTYPE html>
<html lang="fr" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#09090b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>YFitracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: { card: '#18181b' },
                    animation: { 'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite' }
                }
            }
        }
    </script>
    <style>
        body {
            transition: background-color 0.3s ease, color 0.3s ease;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            touch-action: pan-y;
            -webkit-text-size-adjust: 100%;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .dark .glass-panel {
            background: rgba(24, 24, 27, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .liquid-nav {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.1);
        }

        .dark .liquid-nav {
            background: rgba(9, 9, 11, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.5);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .logo-text {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            opacity: 0.95;
        }

        .header-scrolled #logo-container {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.05);
            backdrop-filter: blur(12px);
        }

        .dark .header-scrolled #logo-container {
            background: rgba(9, 9, 11, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header-scrolled #app-logo {
            font-size: 1.25rem;
        }

        #logo-svg {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            width: 3rem;
            height: 3rem;
        }

        .header-scrolled #logo-svg {
            width: 2rem;
            height: 2rem;
        }

        input,
        textarea,
        select {
            font-size: 16px !important;
        }

        @keyframes fade-in-out {
            0% {
                opacity: 0;
                transform: translate(-50%, 20px);
            }

            10% {
                opacity: 1;
                transform: translate(-50%, 0);
            }

            90% {
                opacity: 1;
                transform: translate(-50%, 0);
            }

            100% {
                opacity: 0;
                transform: translate(-50%, -20px);
            }
        }

        .toast-active {
            animation: fade-in-out 2.5s forwards;
        }
    </style>
</head>

<body
    class="antialiased h-full min-h-screen pb-32 selection:bg-red-500/30 bg-gray-50 text-zinc-900 dark:bg-zinc-950 dark:text-white">

    <!-- Header -->
    <header id="main-header"
        class="fixed top-0 left-0 w-full z-50 transition-all duration-300 pointer-events-none flex justify-center py-6">
        <div id="logo-container"
            class="transition-all duration-500 rounded-full px-6 py-2 pointer-events-auto flex items-center gap-3">
            <div id="logo-svg"
                class="rounded-xl bg-gradient-to-br from-red-600 to-red-500 flex items-center justify-center shadow-lg shadow-red-500/30 border-2 border-red-500/20 text-white font-bold text-xl">
                <svg class="w-2/3 h-2/3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v18m0-18l-6 6m6-6l6 6"
                        transform="rotate(180 12 12)" />
                </svg>
            </div>
            <h1 id="app-logo" class="logo-text font-black tracking-tighter text-3xl transition-all duration-500">
                YFitracker</h1>
        </div>
    </header>

    <div class="h-28"></div>

    <!-- Main Content -->
    <main id="app" class="px-4 max-w-lg mx-auto w-full">
        <div id="session-view" class="space-y-6 animate-slide-up"></div>
        <div id="profile-view" class="hidden space-y-6 animate-slide-up"></div>
        <div id="settings-view" class="hidden space-y-6 animate-slide-up"></div>
        <div id="auth-view" class="hidden space-y-6 animate-slide-up"></div>
    </main>

    <!-- Toast Notification -->
    <div id="toast"
        class="fixed top-24 left-1/2 -translate-x-1/2 z-[150] bg-zinc-900 text-white px-6 py-3 rounded-full shadow-2xl border border-zinc-700 flex items-center gap-3 opacity-0 pointer-events-none transition-all">
        <div class="w-2 h-2 rounded-full bg-green-500"></div>
        <span id="toast-message" class="font-bold text-sm">Notification</span>
    </div>

    <!-- Navigation -->
    <nav
        class="fixed bottom-6 left-1/2 -translate-x-1/2 w-auto min-w-[320px] max-w-[90%] liquid-nav z-40 rounded-full px-2 py-2">
        <div class="flex justify-between items-center h-14 relative">
            <button onclick="switchView('session')"
                class="nav-item group relative flex-1 h-full flex flex-col items-center justify-center gap-1 text-zinc-400 dark:text-zinc-500 transition-colors rounded-full hover:bg-black/5 dark:hover:bg-white/5"
                id="nav-session">
                <svg class="w-6 h-6 group-[.active]:text-red-600 transition-colors duration-300" fill="none"
                    stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                        d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                </svg>
                <span
                    class="text-[10px] font-bold group-[.active]:text-zinc-900 dark:group-[.active]:text-white transition-colors">Workout</span>
            </button>
            <button onclick="switchView('profile')"
                class="nav-item group relative flex-1 h-full flex flex-col items-center justify-center gap-1 text-zinc-400 dark:text-zinc-500 transition-colors rounded-full hover:bg-black/5 dark:hover:bg-white/5"
                id="nav-profile">
                <svg class="w-6 h-6 group-[.active]:text-red-600 transition-colors duration-300" fill="none"
                    stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                        d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                <span
                    class="text-[10px] font-bold group-[.active]:text-zinc-900 dark:group-[.active]:text-white transition-colors">Stats</span>
            </button>
            <button onclick="switchView('settings')"
                class="nav-item group relative flex-1 h-full flex flex-col items-center justify-center gap-1 text-zinc-400 dark:text-zinc-500 transition-colors rounded-full hover:bg-black/5 dark:hover:bg-white/5"
                id="nav-settings">
                <svg class="w-6 h-6 group-[.active]:text-red-600 transition-colors duration-300" fill="none"
                    stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                <span
                    class="text-[10px] font-bold group-[.active]:text-zinc-900 dark:group-[.active]:text-white transition-colors">Réglages</span>
            </button>
        </div>
    </nav>

    <!-- Timer -->
    <div id="rest-timer"
        class="fixed inset-0 z-[100] bg-zinc-950/95 backdrop-blur-xl hidden flex-col items-center justify-center p-6 animate-slide-up">
        <div class="absolute inset-0 pointer-events-none overflow-hidden flex items-center justify-center opacity-20">
            <div class="w-[500px] h-[500px] rounded-full border border-red-500/30 animate-pulse-slow"></div>
            <div class="absolute w-[300px] h-[300px] rounded-full border border-red-500/20"></div>
        </div>
        <div class="relative z-10 w-full max-w-sm flex flex-col items-center">
            <p class="text-red-500 font-bold tracking-[0.2em] uppercase text-sm mb-4 animate-pulse">Récupération</p>
            <div class="text-8xl font-bold font-mono text-white mb-8 tracking-tighter tabular-nums" id="timer-display">
                00:00</div>
            <div class="flex items-center gap-6 mb-10">
                <button onclick="adjustTimer(-10)"
                    class="w-16 h-16 rounded-2xl bg-zinc-800 hover:bg-zinc-700 active:scale-95 transition-all flex flex-col items-center justify-center border border-zinc-700 text-white"><span
                        class="text-xl font-bold">-10</span></button>
                <button onclick="toggleTimer()"
                    class="w-24 h-24 rounded-full bg-red-600 hover:bg-red-500 active:scale-95 transition-all shadow-xl shadow-red-900/40 flex items-center justify-center border-4 border-zinc-900">
                    <svg id="timer-icon-pause" class="w-10 h-10 text-white" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M10 9v6m4-6v6" />
                    </svg>
                    <svg id="timer-icon-play" class="w-10 h-10 text-white hidden ml-1" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 3l14 9-14 9V3z" />
                    </svg>
                </button>
                <button onclick="adjustTimer(10)"
                    class="w-16 h-16 rounded-2xl bg-zinc-800 hover:bg-zinc-700 active:scale-95 transition-all flex flex-col items-center justify-center border border-zinc-700 text-white"><span
                        class="text-xl font-bold">+10</span></button>
            </div>
            <button onclick="stopRestTimer()"
                class="px-8 py-3 rounded-xl border border-white/10 text-zinc-400 hover:text-white hover:bg-white/5 transition-all text-sm font-medium tracking-wide">ARRÊTER
                LE CHRONO</button>
        </div>
    </div>

    <!-- Modals (Edit, PR, Session, Import) -->
    <div id="edit-modal"
        class="fixed inset-0 z-[60] bg-black/50 backdrop-blur-sm hidden flex items-end sm:items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md rounded-3xl p-6 shadow-2xl animate-slide-up">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-zinc-900 dark:text-white">Modifier l'exercice</h3><button
                    onclick="closeEditModal()"
                    class="p-2 bg-gray-200 dark:bg-zinc-800 rounded-full text-zinc-500 hover:text-zinc-900 dark:hover:text-white"><svg
                        class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg></button>
            </div>
            <div class="space-y-4">
                <div><label class="text-xs text-zinc-500 uppercase font-bold ml-1 mb-1 block">Nom</label><input
                        type="text" id="edit-name"
                        class="w-full bg-gray-100 dark:bg-zinc-950 border border-gray-200 dark:border-zinc-800 text-zinc-900 dark:text-white rounded-xl px-4 py-3 focus:outline-none focus:border-red-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs text-zinc-500 uppercase font-bold ml-1 mb-1 block">Séries</label><input
                            type="number" id="edit-sets"
                            class="w-full bg-gray-100 dark:bg-zinc-950 border border-gray-200 dark:border-zinc-800 text-zinc-900 dark:text-white rounded-xl px-4 py-3 text-center font-bold">
                    </div>
                    <div><label class="text-xs text-zinc-500 uppercase font-bold ml-1 mb-1 block">Reps</label><input
                            type="text" id="edit-reps"
                            class="w-full bg-gray-100 dark:bg-zinc-950 border border-gray-200 dark:border-zinc-800 text-zinc-900 dark:text-white rounded-xl px-4 py-3 text-center">
                    </div>
                </div>
                <div><label class="text-xs text-zinc-500 uppercase font-bold ml-1 mb-1 block">Repos (sec)</label><input
                        type="number" id="edit-rest"
                        class="w-full bg-gray-100 dark:bg-zinc-950 border border-gray-200 dark:border-zinc-800 text-zinc-900 dark:text-white rounded-xl px-4 py-3 text-center">
                </div>
                <div><label class="text-xs text-zinc-500 uppercase font-bold ml-1 mb-1 block">Focus
                        Musculaire</label><input type="text" id="edit-focus"
                        class="w-full bg-gray-100 dark:bg-zinc-950 border border-gray-200 dark:border-zinc-800 text-zinc-900 dark:text-white rounded-xl px-4 py-3 text-sm">
                </div>
            </div>
            <div class="flex gap-3 mt-8"><button onclick="deleteCurrentExercise()"
                    class="flex-1 py-3.5 rounded-xl border border-red-500/30 text-red-500 font-semibold hover:bg-red-500/10 transition-colors">Supprimer</button><button
                    onclick="saveExerciseChanges()"
                    class="flex-[2] py-3.5 rounded-xl bg-red-600 text-white font-semibold hover:bg-red-500 shadow-lg shadow-red-900/40 transition-all">Sauvegarder</button>
            </div>
        </div>
    </div>

    <div id="pr-modal"
        class="fixed inset-0 z-[60] bg-black/50 backdrop-blur-sm hidden flex items-end sm:items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md rounded-3xl p-6 shadow-2xl animate-slide-up">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-zinc-900 dark:text-white" id="pr-modal-title">Nouveau Record</h3>
                <button onclick="closePRModal()"
                    class="p-2 bg-gray-200 dark:bg-zinc-800 rounded-full text-zinc-500 hover:text-zinc-900 dark:hover:text-white"><svg
                        class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg></button>
            </div>
            <div class="space-y-4">
                <input type="hidden" id="pr-key-hidden">
                <div><label class="text-xs text-zinc-500 uppercase font-bold ml-1 mb-1 block">Exercice</label><input
                        type="text" id="pr-name"
                        class="w-full bg-gray-100 dark:bg-zinc-950 border border-gray-200 dark:border-zinc-800 text-zinc-900 dark:text-white rounded-xl px-4 py-3 focus:border-red-500 outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs text-zinc-500 uppercase font-bold ml-1 mb-1 block">Poids
                            (kg)</label><input type="number" id="pr-weight"
                            class="w-full bg-gray-100 dark:bg-zinc-950 border border-gray-200 dark:border-zinc-800 text-zinc-900 dark:text-white rounded-xl px-4 py-3 text-center font-bold">
                    </div>
                    <div><label class="text-xs text-zinc-500 uppercase font-bold ml-1 mb-1 block">Reps</label><input
                            type="number" id="pr-reps"
                            class="w-full bg-gray-100 dark:bg-zinc-950 border border-gray-200 dark:border-zinc-800 text-zinc-900 dark:text-white rounded-xl px-4 py-3 text-center">
                    </div>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button id="pr-delete-btn" onclick="deletePR()"
                    class="flex-1 py-3.5 rounded-xl border border-red-500/30 text-red-500 font-semibold hover:bg-red-500/10 transition-colors hidden">Supprimer</button>
                <button onclick="savePR()"
                    class="flex-[2] py-3.5 rounded-xl bg-red-600 text-white font-semibold hover:bg-red-500 shadow-lg shadow-red-900/40 transition-all">Enregistrer</button>
            </div>
        </div>
    </div>

    <div id="session-edit-modal"
        class="fixed inset-0 z-[60] bg-black/50 backdrop-blur-sm hidden flex items-end sm:items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md rounded-3xl p-6 shadow-2xl animate-slide-up">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-zinc-900 dark:text-white">Modifier la Séance</h3><button
                    onclick="closeSessionEditModal()"
                    class="p-2 bg-gray-200 dark:bg-zinc-800 rounded-full text-zinc-500 hover:text-zinc-900 dark:hover:text-white"><svg
                        class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg></button>
            </div>
            <div class="space-y-4">
                <input type="hidden" id="edit-session-id">
                <div><label class="text-xs text-zinc-500 uppercase font-bold ml-1 mb-1 block">Nom du
                        Programme</label><input type="text" id="edit-session-name"
                        class="w-full bg-gray-100 dark:bg-zinc-950 border border-gray-200 dark:border-zinc-800 text-zinc-900 dark:text-white rounded-xl px-4 py-3 focus:border-red-500 outline-none">
                </div>
                <div><label class="text-xs text-zinc-500 uppercase font-bold ml-1 mb-1 block">Date
                        (AAAA-MM-JJ)</label><input type="date" id="edit-session-date"
                        class="w-full bg-gray-100 dark:bg-zinc-950 border border-gray-200 dark:border-zinc-800 text-zinc-900 dark:text-white rounded-xl px-4 py-3 focus:border-red-500 outline-none">
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button onclick="saveSessionChanges()"
                    class="w-full py-3.5 rounded-xl bg-red-600 text-white font-semibold hover:bg-red-500 shadow-lg shadow-red-900/40 transition-all">Sauvegarder</button>
            </div>
        </div>
    </div>

    <div id="import-modal"
        class="fixed inset-0 z-[60] bg-black/50 backdrop-blur-sm hidden flex items-end sm:items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md rounded-3xl p-6 shadow-2xl animate-slide-up">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-zinc-900 dark:text-white">Import Intelligent</h3><button
                    onclick="closeImportModal()"
                    class="p-2 bg-gray-200 dark:bg-zinc-800 rounded-full text-zinc-500 hover:text-zinc-900 dark:hover:text-white"><svg
                        class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg></button>
            </div>
            <p class="text-sm text-zinc-500 mb-4">Collez vos notes (Format libre : "DC 100kg 5reps" ou "Squat 4x10
                100kg").</p>
            <textarea id="import-text"
                class="w-full h-32 bg-gray-100 dark:bg-zinc-950 border border-gray-200 dark:border-zinc-800 rounded-xl p-4 text-sm text-zinc-900 dark:text-white resize-none outline-none focus:border-red-500"
                placeholder="Lundi PUSH&#10;DC 100 5&#10;Incliné 80kg 8reps..."></textarea>
            <button onclick="processImport()"
                class="w-full mt-4 bg-red-600 text-white font-bold py-3.5 rounded-xl hover:bg-red-500 transition-all">Analyser
                & Importer</button>
        </div>
    </div>

    <script>
        // --- INIT & THEME ---
        window.addEventListener('scroll', () => { const h = document.getElementById('main-header'); if (window.scrollY > 20) { h.classList.add('header-scrolled', 'py-2'); h.classList.remove('py-6'); } else { h.classList.remove('header-scrolled', 'py-2'); h.classList.add('py-6'); } });
        window.onload = function () {
            loadTheme(); loadPrograms(); loadSession();
            const lastView = localStorage.getItem('onair_current_view') || 'session'; switchView(lastView);
            document.querySelector("meta[name=viewport]").setAttribute("content", "width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no");
        };
        function loadTheme() { if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) document.documentElement.classList.add('dark'); }
        function toggleTheme() { document.documentElement.classList.toggle('dark'); localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light'; renderSettings(); }

        // --- FIREBASE ---
        const firebaseConfig = { apiKey: "AIzaSyB5uqBRZFJRHILeLhYbizGYYfEvEOqTbHc", authDomain: "yutoow-fit.firebaseapp.com", projectId: "yutoow-fit", storageBucket: "yutoow-fit.firebasestorage.app", messagingSenderId: "139731145452", appId: "1:139731145452:web:9a139e7ec8c8acd42d4bc9" };
        let auth, db, currentUser;
        try { firebase.initializeApp(firebaseConfig); auth = firebase.auth(); db = firebase.firestore(); auth.onAuthStateChanged(user => { currentUser = user; if (user) setupRealtimeSync(); renderProfile(); renderSettings(); }); } catch (e) { console.log(e); }

        // --- DATA ---
        const STORAGE_KEY_SESSIONS = 'onair_sessions', STORAGE_KEY_CURRENT_SESSION = 'onair_current_session', STORAGE_KEY_PRS = 'onair_prs', STORAGE_KEY_PROGRAMS = 'onair_programs_v4', STORAGE_KEY_NOTES = 'onair_notes';
        let programs = {}, currentDay = 'lundi', currentExerciseIndex = 0, sessionData = [], currentSessionId = null, sessionStartTime = null, timerInterval = null, timerTargetTime = null, timerPausedRemaining = 0, isTimerPaused = false, wakeLock = null;

        const defaultPrograms = {
            lundi: { id: 'lundi', name: "Lundi - PUSH", exercises: [{ name: "Développé Couché Barre", focus: "Faisceau claviculaire et sternal", sets: 4, reps: "6-8", rest: 120 }, { name: "Développé Incliné Haltères", focus: "Faisceau claviculaire", sets: 3, reps: "8-12", rest: 90 }, { name: "PecFly", focus: "Faisceau sternal", sets: 3, reps: "12-15", rest: 60 }, { name: "Écarté Couché Haltères", focus: "Faisceau sternal (Isolation)", sets: 3, reps: "10-12", rest: 90 }, { name: "Extensions Triceps Nuque Haltère", focus: "Longue portion du triceps", sets: 4, reps: "12-20", rest: 60 }, { name: "Extensions Triceps Corde", focus: "Portions médiane et latérale", sets: 3, reps: "12-15", rest: 60 }] },
            mardi: { id: 'mardi', name: "Mardi - PULL", exercises: [{ name: "Tirage Vertical Poulie Neutre", focus: "Grand Dorsal (Largeur)", sets: 4, reps: "8-12", rest: 105 }, { name: "Tirage Horizontal Neutre", focus: "Trapèzes, Rhomboïdes (Épaisseur)", sets: 3, reps: "10-12", rest: 90 }, { name: "Rowing Machine Unilatéral", focus: "Grand Dorsal (Isolation)", sets: 3, reps: "6-8 / bras", rest: 75 }, { name: "Bûcheron Haltère", focus: "Grand Dorsal, Lombaires", sets: 3, reps: "6-8 / bras", rest: 90 }, { name: "Curl Marteau", focus: "Brachial (Épaisseur bras)", sets: 3, reps: "8-12", rest: 75 }, { name: "Curl Incliné", focus: "Biceps (Longue portion)", sets: 3, reps: "10-12", rest: 75 }] },
            mercredi: { id: 'mercredi', name: "Mercredi - LEGS", exercises: [{ name: "Squat", focus: "Jambes Global", sets: 4, reps: "6-8", rest: 180 }, { name: "Presse à cuisses", focus: "Quadriceps", sets: 4, reps: "10-12", rest: 120 }, { name: "Leg Curl", focus: "Ischio-jambiers", sets: 3, reps: "12-15", rest: 60 }, { name: "Mollets Debout", focus: "Mollets", sets: 4, reps: "15-20", rest: 45 }] },
            vendredi: { id: 'vendredi', name: "Vendredi - Upper", exercises: [{ name: "Développé Militaire", focus: "Épaules", sets: 4, reps: "8-10", rest: 120 }, { name: "Dips", focus: "Pecs/Triceps", sets: 3, reps: "Max", rest: 90 }, { name: "Tirage Poitrine", focus: "Dos Largeur", sets: 4, reps: "10-12", rest: 90 }] },
            samedi: { id: 'samedi', name: "Samedi - Lower", exercises: [{ name: "Soulevé de Terre Roumain", focus: "Ischios/Fessiers", sets: 4, reps: "8-10", rest: 120 }, { name: "Fentes Bulgares", focus: "Fessiers", sets: 3, reps: "10/jambe", rest: 90 }, { name: "Leg Extension", focus: "Quadriceps", sets: 3, reps: "15", rest: 60 }] }
        };

        function getSessions() { try { return JSON.parse(localStorage.getItem(STORAGE_KEY_SESSIONS) || '[]'); } catch (e) { return []; } }
        function getPRs() { try { return JSON.parse(localStorage.getItem(STORAGE_KEY_PRS) || '{}'); } catch (e) { return {}; } }
        function getNotes() { try { return JSON.parse(localStorage.getItem(STORAGE_KEY_NOTES) || '{}'); } catch (e) { return {}; } }
        function loadPrograms() { const saved = localStorage.getItem(STORAGE_KEY_PROGRAMS); programs = saved ? JSON.parse(saved) : defaultPrograms; Object.keys(programs).forEach(k => { if (!programs[k].id) programs[k].id = k; }); }
        function savePrograms() { localStorage.setItem(STORAGE_KEY_PROGRAMS, JSON.stringify(programs)); if (currentUser) saveToCloud(); }

        // --- SESSION ---
        function loadSession() {
            const saved = localStorage.getItem(STORAGE_KEY_CURRENT_SESSION);
            if (!programs[currentDay]) currentDay = Object.keys(programs)[0] || 'lundi';
            if (saved) { const s = JSON.parse(saved); if (s.day === currentDay) { sessionData = s.data || []; currentSessionId = s.id; sessionStartTime = new Date(s.startTime); } }
            if (sessionData.length === 0 && !currentSessionId) { currentSessionId = Date.now().toString(); sessionStartTime = new Date(); }
            renderSessionView();
        }

        function renderSessionView() {
            const program = programs[currentDay];
            const exo = program.exercises[currentExerciseIndex];
            const next = program.exercises[currentExerciseIndex + 1];
            const done = sessionData.filter(s => s.exercise === exo.name).length;
            const keys = Object.keys(programs);
            const notes = getNotes();

            const card = (e, isNext) => `
                <div class="${isNext ? 'absolute top-0 w-full h-full scale-95 blur-sm opacity-50 z-0 pointer-events-none' : 'relative z-10'} bg-white dark:bg-zinc-900 border border-gray-200 dark:border-zinc-800 rounded-3xl p-6 shadow-xl transition-all duration-300" ${isNext ? 'id="next-card"' : 'id="active-card"'}>
                    <div class="mb-6 text-zinc-500 dark:text-zinc-400 text-sm italic border-l-2 border-red-500 pl-3">${e.focus || 'Focus'}</div>
                    <div class="grid grid-cols-2 gap-6 mb-8 relative z-10">
                        <div class="bg-gray-50 dark:bg-zinc-950/50 rounded-2xl p-4 border border-gray-100 dark:border-zinc-800"><div class="text-xs text-zinc-500 uppercase font-bold mb-1">Séries</div><div class="text-3xl font-bold text-zinc-900 dark:text-white" id="set-counter">${done}<span class="text-zinc-400 text-xl">/${e.sets}</span></div></div>
                        <div class="bg-gray-50 dark:bg-zinc-950/50 rounded-2xl p-4 border border-gray-100 dark:border-zinc-800"><div class="text-xs text-zinc-500 uppercase font-bold mb-1">Objectif</div><div class="text-3xl font-bold text-zinc-900 dark:text-white">${e.reps}</div></div>
                    </div>
                    ${!isNext ? `<div class="space-y-6 relative z-10"><div class="flex gap-6"><div class="flex-1"><label class="text-xs text-zinc-400 font-bold ml-1 mb-2 block">CHARGE</label><input type="number" id="weight-input" placeholder="0" class="w-full bg-gray-100 dark:bg-zinc-950 border border-gray-200 dark:border-zinc-700 rounded-2xl py-4 text-center text-2xl font-bold text-zinc-900 dark:text-white focus:border-red-500 outline-none pointer-events-auto"></div><div class="flex-1"><label class="text-xs text-zinc-400 font-bold ml-1 mb-2 block">REPS</label><input type="number" id="reps-input" placeholder="0" class="w-full bg-gray-100 dark:bg-zinc-950 border border-gray-200 dark:border-zinc-700 rounded-2xl py-4 text-center text-2xl font-bold text-zinc-900 dark:text-white focus:border-red-500 outline-none pointer-events-auto"></div></div><button onclick="logSet()" class="w-full bg-zinc-900 dark:bg-white text-white dark:text-black font-bold text-lg py-4 rounded-2xl hover:opacity-90 active:scale-95 transition-all pointer-events-auto">Valider</button></div>` : ''}
                </div>`;

            // HTML Structure: Session View
            const html = `
                <div class="flex gap-3 overflow-x-auto pb-4 no-scrollbar -mx-4 px-4 snap-x">${keys.map((k, i) => `<button onclick="changeDay('${k}')" class="snap-center shrink-0 flex flex-col items-center justify-center w-16 h-20 rounded-2xl border transition-all ${currentDay === k ? 'bg-red-600 border-red-500 text-white shadow-lg' : 'bg-white dark:bg-zinc-900 border-gray-200 dark:border-zinc-800 text-zinc-500'}"><span class="text-[10px] uppercase font-bold opacity-80">${programs[k].name.split(' ')[0].substring(0, 3)}</span><span class="text-xl font-bold mt-1">${i + 1}</span></button>`).join('')}</div>
                <div id="swipe-area" class="relative group perspective-1000 min-h-[450px]">
                    <div class="flex justify-between items-end mb-5 px-1 relative z-20"><div><span class="text-xs text-red-600 dark:text-red-500 font-bold uppercase tracking-wider">Exercice ${currentExerciseIndex + 1} / ${program.exercises.length}</span><h2 class="text-2xl font-bold text-zinc-900 dark:text-white leading-tight mt-1">${exo.name}</h2></div><button onclick="openEditModal()" class="p-2 text-zinc-400 pointer-events-auto"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg></button></div>
                    <div id="cards-stack" class="relative w-full">${next ? card(next, true) : ''}${card(exo, false)}</div>
                    <div class="flex justify-between items-center px-4 mt-3 text-zinc-400 text-xs font-medium relative z-20"><button onclick="prevExercise()" class="p-2 pointer-events-auto">Précédent</button><span>Swipe pour naviguer</span><button onclick="nextExercise()" class="p-2 pointer-events-auto">Suivant</button></div>
                </div>
                <div class="mt-6 mx-1 animate-slide-up">
                    <label class="text-xs text-zinc-400 font-bold uppercase tracking-wider ml-1 mb-2 block flex items-center gap-2"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>Notes sur l'exercice</label>
                    <textarea oninput="saveCurrentNote(this.value)" class="w-full bg-white dark:bg-zinc-900 border border-gray-200 dark:border-zinc-800 rounded-2xl p-4 text-sm focus:border-red-500 focus:ring-1 focus:ring-red-500 outline-none resize-none h-24 shadow-sm transition-all text-zinc-800 dark:text-zinc-200 placeholder-zinc-400 pointer-events-auto" placeholder="Ex: Siège au cran 4, attention épaule gauche...">${notes[exo.name] || ''}</textarea>
                </div>
                <div id="history-container" class="mt-6"></div>
                <div class="h-8"></div>
            `;
            document.getElementById('session-view').innerHTML = html;
            setupSwipe();
            updateHistoryUI(); // CRITICAL: Populate history immediately
            setTimeout(() => { const pr = getPRs()[exo.name]; if (pr) document.getElementById('weight-input').value = pr.weight; }, 50);
        }

        // --- NEW FUNCTION: INSTANT HISTORY UPDATE ---
        function updateHistoryUI() {
            const container = document.getElementById('history-container');
            if (!container) return;
            const program = programs[currentDay];
            const exo = program.exercises[currentExerciseIndex];
            const sets = sessionData.filter(s => s.exercise === exo.name);
            const done = sets.length;

            // Update counter in card
            const counterEl = document.getElementById('set-counter');
            if (counterEl) counterEl.innerHTML = `${done}<span class="text-zinc-400 text-xl">/${exo.sets}</span>`;

            if (done === 0) { container.innerHTML = ''; return; }

            container.innerHTML = `
                <div class="animate-slide-up">
                    <h3 class="text-sm font-bold text-zinc-400 uppercase tracking-wider mb-3 px-1">Séries Terminées</h3>
                    <div class="space-y-2">
                        ${sets.map((s, i) => `
                            <div class="flex justify-between bg-white dark:bg-zinc-900 border border-gray-100 dark:border-zinc-800 rounded-xl p-4 shadow-sm">
                                <div class="flex gap-3 items-center">
                                    <div class="w-6 h-6 rounded-full bg-red-100 dark:bg-red-500/10 text-red-600 dark:text-red-500 flex items-center justify-center text-xs font-bold">${i + 1}</div>
                                    <span class="text-sm text-zinc-500">Terminée</span>
                                </div>
                                <span class="font-bold font-mono text-zinc-900 dark:text-white">${s.weight}kg <span class="text-zinc-400">x</span> ${s.reps}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
        }

        // --- SWIPE ---
        let tx = 0, ty = 0, swiping = false;
        function setupSwipe() {
            const el = document.getElementById('swipe-area'); if (!el) return;
            el.addEventListener('touchstart', e => { if (e.target.closest('input, button, textarea')) { swiping = false; return; } tx = e.touches[0].clientX; ty = e.touches[0].clientY; swiping = true; const c = document.getElementById('active-card'); if (c) c.style.transition = 'none'; }, { passive: false });
            el.addEventListener('touchmove', e => { if (!swiping) return; const dx = e.touches[0].clientX - tx, dy = e.touches[0].clientY - ty; if (Math.abs(dy) > Math.abs(dx)) { swiping = false; return; } if (Math.abs(dx) > 10 && e.cancelable) e.preventDefault(); const c = document.getElementById('active-card'); if (c) c.style.transform = `translateX(${dx}px) rotate(${dx / 25}deg)`; }, { passive: false });
            el.addEventListener('touchend', e => { if (!swiping) return; swiping = false; const dx = e.changedTouches[0].clientX - tx; const c = document.getElementById('active-card'); if (!c) return; c.style.transition = 'transform 0.4s ease'; if (Math.abs(dx) > 100) { c.style.transform = `translateX(${dx > 0 ? window.innerWidth : -window.innerWidth}px)`; setTimeout(() => dx > 0 ? prevExercise() : nextExercise(), 300); } else { c.style.transform = 'translateX(0)'; } });
        }
        function prevExercise() { if (currentExerciseIndex > 0) { currentExerciseIndex--; loadSession(); } }
        function nextExercise() { if (currentExerciseIndex < programs[currentDay].exercises.length - 1) { currentExerciseIndex++; loadSession(); } }
        function changeDay(day) { currentDay = day; currentExerciseIndex = 0; loadSession(); }

        // --- LOG SET & LOGIC ---
        function logSet() {
            const w = document.getElementById('weight-input').value, r = document.getElementById('reps-input').value;
            if (!w || !r) return;
            const ex = programs[currentDay].exercises[currentExerciseIndex];

            // Push Data
            sessionData.push({ day: currentDay, programName: programs[currentDay].name, exercise: ex.name, weight: w, reps: r, timestamp: new Date().toISOString() });
            localStorage.setItem(STORAGE_KEY_CURRENT_SESSION, JSON.stringify({ id: currentSessionId, startTime: sessionStartTime, data: sessionData, day: currentDay }));
            if (currentUser) saveToCloud();

            // PR Update
            const prs = getPRs(), old = prs[ex.name] || { weight: 0, reps: 0 };
            if (parseFloat(w) > old.weight || (parseFloat(w) === old.weight && parseInt(r) > old.reps)) { prs[ex.name] = { weight: parseFloat(w), reps: parseInt(r), date: new Date().toISOString() }; localStorage.setItem(STORAGE_KEY_PRS, JSON.stringify(prs)); }

            // Clear Inputs
            document.getElementById('reps-input').value = '';

            // Instant UI Update (Crucial Fix)
            updateHistoryUI();

            // Check completion
            if (sessionData.filter(s => s.exercise === ex.name).length >= ex.sets) {
                if (currentExerciseIndex < programs[currentDay].exercises.length - 1) {
                    showToast("Exercice terminé ! Prochain...");
                    setTimeout(() => { currentExerciseIndex++; loadSession(); }, 1500);
                } else {
                    showSessionComplete();
                }
            }
            startRestTimer(ex.rest);
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-message').textContent = msg;
            t.classList.remove('pointer-events-none', 'opacity-0');
            t.classList.add('toast-active');
            setTimeout(() => { t.classList.remove('toast-active'); t.classList.add('opacity-0', 'pointer-events-none'); }, 2500);
        }

        function saveCurrentNote(val) { const ex = programs[currentDay].exercises[currentExerciseIndex]; const notes = getNotes(); notes[ex.name] = val; localStorage.setItem(STORAGE_KEY_NOTES, JSON.stringify(notes)); }

        // --- TIMER ---
        function startRestTimer(s) { document.getElementById('rest-timer').classList.remove('hidden'); document.getElementById('rest-timer').classList.add('flex'); timerTargetTime = Date.now() + (s * 1000); isTimerPaused = false; updateTimer(); requestWakeLock(); clearInterval(timerInterval); timerInterval = setInterval(timerLoop, 100); }
        function timerLoop() { if (!isTimerPaused) { const diff = Math.ceil((timerTargetTime - Date.now()) / 1000); if (diff <= 0) stopRestTimer(true); else updateTimer(diff); } }
        function updateTimer(val) { const v = val !== undefined ? val : Math.ceil((timerTargetTime - Date.now()) / 1000); const m = Math.floor(v / 60), s = v % 60; document.getElementById('timer-display').textContent = `${m < 10 ? '0' + m : m}:${s < 10 ? '0' + s : s}`; }
        function toggleTimer() { isTimerPaused = !isTimerPaused; document.getElementById('timer-icon-pause').classList.toggle('hidden', isTimerPaused); document.getElementById('timer-icon-play').classList.toggle('hidden', !isTimerPaused); if (isTimerPaused) timerPausedRemaining = Math.ceil((timerTargetTime - Date.now()) / 1000); else timerTargetTime = Date.now() + (timerPausedRemaining * 1000); }
        function adjustTimer(s) { if (isTimerPaused) { timerPausedRemaining += s; updateTimer(timerPausedRemaining); } else { timerTargetTime += s * 1000; updateTimer(); } }
        function stopRestTimer(sound = false) { clearInterval(timerInterval); document.getElementById('rest-timer').classList.add('hidden'); document.getElementById('rest-timer').classList.remove('flex'); if (sound && navigator.vibrate) navigator.vibrate([200, 100, 200]); }
        async function requestWakeLock() { try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (e) { } }

        // --- VIEWS ---
        function switchView(view) {
            ['session', 'profile', 'settings', 'auth'].forEach(v => { document.getElementById(`${v}-view`).classList.add('hidden'); document.getElementById(`nav-${v}`)?.classList.remove('active'); });
            const t = document.getElementById(`${view}-view`); t.classList.remove('hidden'); t.classList.remove('animate-slide-up'); void t.offsetWidth; t.classList.add('animate-slide-up');
            document.getElementById(`nav-${view}`)?.classList.add('active');
            localStorage.setItem('onair_current_view', view);
            if (view === 'profile') renderProfile(); if (view === 'settings') renderSettings(); if (view === 'auth') renderAuth();
            window.scrollTo(0, 0);
        }

        // --- STATS ---
        function renderProfile() {
            const sessions = getSessions().sort((a, b) => new Date(b.startTime) - new Date(a.startTime));
            const prs = getPRs();
            const grouped = {};
            sessions.forEach(s => { const cat = s.programName.split(' ')[0] || "Autre"; if (!grouped[cat]) grouped[cat] = []; grouped[cat].push(s); });

            let html = `
                <div class="glass-panel rounded-3xl p-6 shadow-sm mb-6">
                    <h2 class="text-2xl font-bold mb-4 text-zinc-900 dark:text-white">Records (PRs)</h2>
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        ${Object.entries(prs).map(([name, data]) => `
                            <div class="relative bg-white dark:bg-zinc-900 border border-gray-100 dark:border-zinc-800 p-4 rounded-2xl shadow-sm hover:border-red-500 transition-colors">
                                <button onclick="openPRModal('${name}', ${data.weight}, ${data.reps})" class="absolute top-2 right-2 bg-gray-200 dark:bg-zinc-800 rounded-full p-1 text-zinc-500 hover:text-white hover:bg-red-500 transition-colors"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg></button>
                                <p class="text-xs text-zinc-500 truncate mb-1 pr-6">${name}</p>
                                <p class="text-xl font-bold text-zinc-900 dark:text-white">${data.weight} <span class="text-sm text-zinc-400">kg</span></p>
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="openPRModal()" class="w-full py-3 rounded-xl border border-dashed border-gray-300 dark:border-zinc-700 text-zinc-500 text-sm font-medium hover:text-red-500 hover:border-red-500 transition-colors">+ Ajouter un record</button>
                </div>

                <div class="glass-panel rounded-3xl p-6 shadow-sm mb-6">
                    <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-zinc-900 dark:text-white">Import Note</h2><button onclick="document.getElementById('import-modal').classList.remove('hidden'); document.getElementById('import-modal').classList.add('flex')" class="text-xs bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 px-3 py-1 rounded-full font-bold">IA Local</button></div>
                    <p class="text-xs text-zinc-500">Collez un résumé texte pour l'ajouter à l'historique.</p>
                </div>

                <div class="space-y-6 pb-20">
                    <h2 class="text-2xl font-bold px-2 text-zinc-900 dark:text-white">Historique</h2>
                    ${Object.keys(grouped).length === 0 ? '<p class="px-2 text-zinc-500">Aucune séance.</p>' : ''}
                    ${Object.entries(grouped).map(([cat, list]) => `
                        <div>
                            <h3 class="font-bold text-red-500 uppercase tracking-wider text-xs mb-3 px-2 border-b border-gray-200 dark:border-zinc-800 pb-1">${cat}</h3>
                            <div class="space-y-2">
                                ${list.map(s => {
                const date = new Date(s.startTime).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
                const dateISO = new Date(s.startTime).toISOString().split('T')[0];
                return `
                                    <div class="bg-white dark:bg-zinc-900 border border-gray-100 dark:border-zinc-800 p-4 rounded-2xl flex justify-between items-center shadow-sm group">
                                        <div><p class="font-bold text-zinc-900 dark:text-white">${s.programName}</p><p class="text-xs text-zinc-500">${date} • ${s.data ? s.data.length : 0} séries</p></div>
                                        <div class="flex gap-2">
                                            <button onclick="openSessionEditModal('${s.id}', '${s.programName}', '${dateISO}')" class="bg-gray-100 dark:bg-zinc-800 p-2 rounded-full text-zinc-500 hover:text-white hover:bg-blue-500 transition-colors"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg></button>
                                            <button onclick="deleteSession('${s.id}')" class="bg-gray-100 dark:bg-zinc-800 p-2 rounded-full text-zinc-500 hover:text-white hover:bg-red-500 transition-colors"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                                        </div>
                                    </div>`
            }).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            document.getElementById('profile-view').innerHTML = html;
        }

        // --- HANDLERS (EDIT & SAVE) ---
        function openSessionEditModal(id, name, date) { document.getElementById('edit-session-id').value = id; document.getElementById('edit-session-name').value = name; document.getElementById('edit-session-date').value = date; document.getElementById('session-edit-modal').classList.remove('hidden'); document.getElementById('session-edit-modal').classList.add('flex'); }
        function closeSessionEditModal() { document.getElementById('session-edit-modal').classList.add('hidden'); document.getElementById('session-edit-modal').classList.remove('flex'); }
        function saveSessionChanges() {
            const id = document.getElementById('edit-session-id').value, newName = document.getElementById('edit-session-name').value, newDate = document.getElementById('edit-session-date').value;
            if (!newName || !newDate) return alert("Remplissez tout");
            const sessions = getSessions(), idx = sessions.findIndex(s => s.id === id);
            if (idx !== -1) { sessions[idx].programName = newName; sessions[idx].startTime = new Date(newDate).toISOString(); localStorage.setItem(STORAGE_KEY_SESSIONS, JSON.stringify(sessions)); if (currentUser) saveToCloud(); closeSessionEditModal(); renderProfile(); }
        }
        function deleteSession(id) { if (!confirm("Supprimer ?")) return; const sessions = getSessions().filter(s => s.id !== id); localStorage.setItem(STORAGE_KEY_SESSIONS, JSON.stringify(sessions)); if (currentUser) saveToCloud(); renderProfile(); }

        function openPRModal(name = '', weight = '', reps = '') { document.getElementById('pr-modal').classList.remove('hidden'); document.getElementById('pr-modal').classList.add('flex'); document.getElementById('pr-name').value = name; document.getElementById('pr-weight').value = weight; document.getElementById('pr-reps').value = reps; document.getElementById('pr-key-hidden').value = name; document.getElementById('pr-modal-title').textContent = name ? "Modifier Record" : "Nouveau Record"; document.getElementById('pr-delete-btn').classList.toggle('hidden', !name); }
        function closePRModal() { document.getElementById('pr-modal').classList.add('hidden'); document.getElementById('pr-modal').classList.remove('flex'); }
        function savePR() { const name = document.getElementById('pr-name').value, weight = parseFloat(document.getElementById('pr-weight').value), reps = parseInt(document.getElementById('pr-reps').value); if (!name || isNaN(weight)) return; const prs = getPRs(), old = document.getElementById('pr-key-hidden').value; if (old && old !== name) delete prs[old]; prs[name] = { weight, reps: isNaN(reps) ? 0 : reps, date: new Date().toISOString() }; localStorage.setItem(STORAGE_KEY_PRS, JSON.stringify(prs)); if (currentUser) saveToCloud(); closePRModal(); renderProfile(); }
        function deletePR() { const name = document.getElementById('pr-key-hidden').value; if (!confirm("Supprimer ?")) return; const prs = getPRs(); delete prs[name]; localStorage.setItem(STORAGE_KEY_PRS, JSON.stringify(prs)); if (currentUser) saveToCloud(); closePRModal(); renderProfile(); }

        function closeImportModal() { document.getElementById('import-modal').classList.add('hidden'); document.getElementById('import-modal').classList.remove('flex'); }
        function processImport() {
            const text = document.getElementById('import-text').value; if (!text) return;
            let programName = "Importée"; if (text.match(/push|pecs/i)) programName = "Lundi - PUSH"; else if (text.match(/pull|dos/i)) programName = "Mardi - PULL"; else if (text.match(/legs/i)) programName = "Mercredi - LEGS";
            const sessionSets = [], lines = text.split('\n'), prs = getPRs();
            // Regex améliorée: Nom + (Séparateur) + (Sets x) + Reps + (x|@) + Poids OU Poids + Reps
            // Cas 1: "Curl 3x12 20kg"
            // Cas 2: "DC 100 5"
            let prsUpdated = false;

            lines.forEach(line => {
                let exercise, weight, reps, sets = 1;

                // Essai format complet: "Curl 3x12 20kg" ou "Curl 3x12 @ 20"
                let match = line.match(/^(.+?)\s+(\d+)\s*[xX]\s*(\d+)\s*(?:@|à)?\s*(\d+[.,]?\d*)/);
                if (match) {
                    exercise = match[1].trim(); sets = parseInt(match[2]); reps = parseInt(match[3]); weight = parseFloat(match[4].replace(',', '.'));
                } else {
                    // Essai format simple: "DC 100 5" ou "DC 100kg 5reps"
                    match = line.match(/^(.+?)\s+(\d+[.,]?\d*)\s*(?:kg)?\s*[xX]?\s*(\d+)/);
                    if (match) {
                        exercise = match[1].trim(); weight = parseFloat(match[2].replace(',', '.')); reps = parseInt(match[3]);
                    }
                }

                if (exercise && !isNaN(weight)) {
                    // Ignore les titres de séance
                    if (exercise.length < 2 || exercise.toLowerCase().includes("séance")) return;

                    for (let i = 0; i < sets; i++) {
                        sessionSets.push({ exercise, weight, reps, day: 'import', programName, timestamp: new Date().toISOString() });
                    }

                    const cur = prs[exercise] || { weight: 0, reps: 0 };
                    if (weight > cur.weight || (weight === cur.weight && reps > cur.reps)) { prs[exercise] = { weight, reps, date: new Date().toISOString() }; prsUpdated = true; }
                }
            });

            if (sessionSets.length === 0) return alert("Aucun exercice détecté. Essayez le format: 'Exercice Poids Reps' ou 'Exercice Séries x Reps Poids'");

            const newSession = { id: Date.now().toString(), startTime: new Date().toISOString(), endTime: new Date().toISOString(), programName, totalSets: sessionSets.length, data: sessionSets };
            const sessions = getSessions(); sessions.push(newSession); localStorage.setItem(STORAGE_KEY_SESSIONS, JSON.stringify(sessions)); if (prsUpdated) localStorage.setItem(STORAGE_KEY_PRS, JSON.stringify(prs)); if (currentUser) saveToCloud();
            alert(`${sessionSets.length} séries importées.`); closeImportModal(); renderProfile();
        }

        function renderSettings() { document.getElementById('settings-view').innerHTML = `<div class="glass-panel rounded-3xl p-6 shadow-sm space-y-4"><h2 class="text-2xl font-bold text-zinc-900 dark:text-white">Paramètres</h2><button onclick="toggleTheme()" class="w-full flex justify-between items-center p-4 bg-gray-100 dark:bg-zinc-900 rounded-xl text-zinc-900 dark:text-white"><span>Mode Sombre</span><div class="w-12 h-6 bg-zinc-300 dark:bg-zinc-700 rounded-full relative transition-colors"><div class="w-5 h-5 bg-white rounded-full absolute top-0.5 transition-all ${document.documentElement.classList.contains('dark') ? 'left-[1.6rem]' : 'left-0.5'} shadow-sm"></div></div></button><div class="pt-6 border-t border-gray-200 dark:border-zinc-800 space-y-3"><button onclick="clearUserData()" class="w-full py-4 bg-red-500/10 border border-red-500/20 text-red-600 dark:text-red-500 font-bold hover:bg-red-500/20 text-sm rounded-xl">Supprimer Stats & Records</button><button onclick="if(confirm('Tout réinitialiser ?')){localStorage.clear(); location.reload();}" class="w-full py-3 text-zinc-400 hover:text-zinc-600 dark:hover:text-white font-medium text-xs">Réinitialisation d'usine</button></div></div>`; }
        async function clearUserData() { if (!confirm("Supprimer l'historique ?")) return; localStorage.removeItem(STORAGE_KEY_SESSIONS); localStorage.removeItem(STORAGE_KEY_PRS); if (currentUser) await db.collection('users').doc(currentUser.uid).set({ sessions: "[]", prs: "{}" }, { merge: true }); alert("Données effacées."); renderProfile(); }
        function renderAuth() { document.getElementById('auth-view').innerHTML = `<div class="glass-panel rounded-3xl p-8 shadow-xl mt-10"><h2 class="text-2xl font-bold mb-6 text-center text-zinc-900 dark:text-white">Connexion</h2><div class="space-y-4"><input type="email" id="auth-email" placeholder="Email" class="w-full bg-gray-100 dark:bg-zinc-900 border border-gray-200 dark:border-zinc-800 text-zinc-900 dark:text-white rounded-xl px-4 py-3 outline-none"><input type="password" id="auth-password" placeholder="Mot de passe" class="w-full bg-gray-100 dark:bg-zinc-900 border border-gray-200 dark:border-zinc-800 text-zinc-900 dark:text-white rounded-xl px-4 py-3 outline-none"></div><div class="grid grid-cols-2 gap-3 mt-6"><button onclick="handleLogin()" class="bg-gray-200 dark:bg-zinc-800 text-zinc-900 dark:text-white py-3 rounded-xl font-bold">Connexion</button><button onclick="handleSignup()" class="bg-red-600 text-white py-3 rounded-xl font-bold">Créer</button></div></div>`; }
        async function handleLogin() { try { await auth.signInWithEmailAndPassword(document.getElementById('auth-email').value, document.getElementById('auth-password').value); switchView('profile'); } catch (e) { alert(e.message); } }
        async function handleSignup() { try { await auth.createUserWithEmailAndPassword(document.getElementById('auth-email').value, document.getElementById('auth-password').value); switchView('profile'); } catch (e) { alert(e.message); } }
        function setupRealtimeSync() { if (!currentUser) return; db.collection('users').doc(currentUser.uid).onSnapshot(doc => { if (doc.exists) { const d = doc.data(); if (d.programs) { programs = JSON.parse(d.programs); localStorage.setItem(STORAGE_KEY_PROGRAMS, d.programs); } } }); }

        function openEditModal() { const ex = programs[currentDay].exercises[currentExerciseIndex]; document.getElementById('edit-name').value = ex.name; document.getElementById('edit-sets').value = ex.sets; document.getElementById('edit-reps').value = ex.reps; document.getElementById('edit-rest').value = ex.rest; document.getElementById('edit-focus').value = ex.focus || ""; document.getElementById('edit-modal').classList.remove('hidden'); document.getElementById('edit-modal').classList.add('flex'); }
        function closeEditModal() { document.getElementById('edit-modal').classList.add('hidden'); document.getElementById('edit-modal').classList.remove('flex'); }
        function saveExerciseChanges() {
            const name = document.getElementById('edit-name').value, sets = parseInt(document.getElementById('edit-sets').value), reps = document.getElementById('edit-reps').value, rest = parseInt(document.getElementById('edit-rest').value), focus = document.getElementById('edit-focus').value;
            if (!name) return;
            const oldName = programs[currentDay].exercises[currentExerciseIndex].name;
            programs[currentDay].exercises[currentExerciseIndex] = { name, sets, reps, rest, focus };
            if (oldName !== name) {
                sessionData = sessionData.map(s => s.exercise === oldName ? { ...s, exercise: name } : s);
                localStorage.setItem(STORAGE_KEY_CURRENT_SESSION, JSON.stringify({ id: currentSessionId, startTime: sessionStartTime, data: sessionData, day: currentDay }));
            }
            savePrograms(); closeEditModal(); loadSession();
        }
        function deleteCurrentExercise() { if (confirm("Supprimer ?")) { programs[currentDay].exercises.splice(currentExerciseIndex, 1); savePrograms(); closeEditModal(); if (currentExerciseIndex >= programs[currentDay].exercises.length) currentExerciseIndex = Math.max(0, programs[currentDay].exercises.length - 1); loadSession(); } }
        function addNewDay() { const id = prompt("ID (ex: dimanche)"); if (id) { programs[id.toLowerCase()] = { id: id.toLowerCase(), name: id, exercises: [{ name: "New", sets: 3, reps: 10, rest: 60 }] }; savePrograms(); changeDay(id.toLowerCase()); } }

        function showSessionComplete() { document.getElementById('session-view').innerHTML = `<div class="glass-panel rounded-3xl p-8 text-center animate-slide-up mt-10"><div class="text-6xl mb-4">🔥</div><h2 class="text-3xl font-bold mb-2 text-zinc-900 dark:text-white">Séance Terminée !</h2><p class="text-zinc-500 dark:text-zinc-400 mb-8">Repose-toi bien, guerrier.</p><button onclick="currentExerciseIndex=0; sessionData=[]; loadSession()" class="w-full bg-zinc-900 dark:bg-white text-white dark:text-black font-bold py-4 rounded-xl">Nouvelle Séance</button></div>`; }
    </script>
</body>

</html>