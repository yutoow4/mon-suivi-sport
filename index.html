<!DOCTYPE html>
<html lang="fr" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#09090b">
    <title>YFitracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                    },
                    colors: {
                        card: '#18181b',
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            transition: background-color 0.3s ease, color 0.3s ease;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .dark .glass-panel {
            background: rgba(24, 24, 27, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .liquid-nav {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.1);
        }

        .dark .liquid-nav {
            background: rgba(9, 9, 11, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.5);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .logo-text {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            opacity: 0.95;
        }

        /* Animation du Header au scroll */
        .header-scrolled #logo-container {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.05);
            backdrop-filter: blur(12px);
        }

        .dark .header-scrolled #logo-container {
            background: rgba(9, 9, 11, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header-scrolled #app-logo {
            font-size: 1.25rem;
            /* text-xl */
        }

        /* Animation spécifique du logo SVG */
        #logo-svg {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            width: 3rem;
            /* w-12 par défaut (48px) */
            height: 3rem;
        }

        .header-scrolled #logo-svg {
            width: 2rem;
            /* w-8 au scroll (32px) */
            height: 2rem;
        }
    </style>
</head>

<body
    class="antialiased h-full min-h-screen pb-32 selection:bg-red-500/30 bg-gray-50 text-zinc-900 dark:bg-zinc-950 dark:text-white">

    <!-- Dynamic Header -->
    <header id="main-header"
        class="fixed top-0 left-0 w-full z-50 transition-all duration-300 pointer-events-none flex justify-center py-6">
        <div id="logo-container"
            class="transition-all duration-500 rounded-full px-6 py-2 pointer-events-auto flex items-center gap-3">

            <!-- Logo SVG -->
            <div id="logo-svg"
                class="rounded-xl bg-gradient-to-br from-red-600 to-red-500 flex items-center justify-center shadow-lg shadow-red-500/30 border-2 border-red-500/20 text-white font-bold text-xl">
                <svg class="w-2/3 h-2/3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v18m0-18l-6 6m6-6l6 6"
                        transform="rotate(180 12 12)" />
                </svg>
            </div>

            <h1 id="app-logo" class="logo-text font-black tracking-tighter text-3xl transition-all duration-500">
                YFitracker
            </h1>
        </div>
    </header>

    <div class="h-28"></div> <!-- Spacer -->

    <!-- Main App Container -->
    <main id="app" class="px-4 max-w-lg mx-auto w-full">
        <div id="session-view" class="space-y-6 animate-slide-up"></div>
        <div id="profile-view" class="hidden space-y-6 animate-slide-up"></div>
        <div id="settings-view" class="hidden space-y-6 animate-slide-up"></div>
        <div id="auth-view" class="hidden space-y-6 animate-slide-up"></div>
    </main>

    <!-- Liquid Bottom Navigation -->
    <nav
        class="fixed bottom-6 left-1/2 -translate-x-1/2 w-auto min-w-[320px] max-w-[90%] liquid-nav z-40 rounded-full px-2 py-2">
        <div class="flex justify-between items-center h-14 relative">
            <button onclick="switchView('session')"
                class="nav-item group relative flex-1 h-full flex flex-col items-center justify-center gap-1 text-zinc-400 dark:text-zinc-500 transition-colors rounded-full hover:bg-black/5 dark:hover:bg-white/5"
                id="nav-session">
                <svg class="w-6 h-6 group-[.active]:text-red-600 transition-colors duration-300" fill="none"
                    stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                        d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                </svg>
                <span
                    class="text-[10px] font-bold group-[.active]:text-zinc-900 dark:group-[.active]:text-white transition-colors">Workout</span>
            </button>

            <button onclick="switchView('profile')"
                class="nav-item group relative flex-1 h-full flex flex-col items-center justify-center gap-1 text-zinc-400 dark:text-zinc-500 transition-colors rounded-full hover:bg-black/5 dark:hover:bg-white/5"
                id="nav-profile">
                <svg class="w-6 h-6 group-[.active]:text-red-600 transition-colors duration-300" fill="none"
                    stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                        d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                <span
                    class="text-[10px] font-bold group-[.active]:text-zinc-900 dark:group-[.active]:text-white transition-colors">Stats</span>
            </button>

            <button onclick="switchView('settings')"
                class="nav-item group relative flex-1 h-full flex flex-col items-center justify-center gap-1 text-zinc-400 dark:text-zinc-500 transition-colors rounded-full hover:bg-black/5 dark:hover:bg-white/5"
                id="nav-settings">
                <svg class="w-6 h-6 group-[.active]:text-red-600 transition-colors duration-300" fill="none"
                    stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                <span
                    class="text-[10px] font-bold group-[.active]:text-zinc-900 dark:group-[.active]:text-white transition-colors">Réglages</span>
            </button>
        </div>
    </nav>

    <!-- Full Screen Immersive Timer -->
    <div id="rest-timer"
        class="fixed inset-0 z-[100] bg-zinc-950/90 backdrop-blur-xl hidden flex-col items-center justify-center p-6 animate-slide-up">
        <div class="absolute inset-0 pointer-events-none overflow-hidden flex items-center justify-center opacity-20">
            <div class="w-[500px] h-[500px] rounded-full border border-red-500/30 animate-pulse-slow"></div>
            <div class="absolute w-[300px] h-[300px] rounded-full border border-red-500/20"></div>
        </div>

        <div class="relative z-10 w-full max-w-sm flex flex-col items-center">
            <p class="text-red-500 font-bold tracking-[0.2em] uppercase text-sm mb-4 animate-pulse">Récupération</p>
            <div class="text-8xl font-bold font-mono text-white mb-8 tracking-tighter tabular-nums" id="timer-display">
                00:00</div>
            <div class="flex items-center gap-6 mb-10">
                <button onclick="adjustTimer(-10)"
                    class="w-16 h-16 rounded-2xl bg-zinc-800 hover:bg-zinc-700 active:scale-95 transition-all flex flex-col items-center justify-center border border-zinc-700 text-white">
                    <span class="text-xl font-bold">-10</span>
                </button>
                <button onclick="toggleTimer()"
                    class="w-24 h-24 rounded-full bg-red-600 hover:bg-red-500 active:scale-95 transition-all shadow-xl shadow-red-900/40 flex items-center justify-center border-4 border-zinc-900">
                    <svg id="timer-icon-pause" class="w-10 h-10 text-white" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M10 9v6m4-6v6" />
                    </svg>
                    <svg id="timer-icon-play" class="w-10 h-10 text-white hidden ml-1" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 3l14 9-14 9V3z" />
                    </svg>
                </button>
                <button onclick="adjustTimer(10)"
                    class="w-16 h-16 rounded-2xl bg-zinc-800 hover:bg-zinc-700 active:scale-95 transition-all flex flex-col items-center justify-center border border-zinc-700 text-white">
                    <span class="text-xl font-bold">+10</span>
                </button>
            </div>
            <button onclick="stopRestTimer()"
                class="px-8 py-3 rounded-xl border border-white/10 text-zinc-400 hover:text-white hover:bg-white/5 transition-all text-sm font-medium tracking-wide">
                ARRÊTER LE CHRONO
            </button>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal"
        class="fixed inset-0 z-[60] bg-black/50 backdrop-blur-sm hidden flex items-end sm:items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md rounded-3xl p-6 shadow-2xl animate-slide-up">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-zinc-900 dark:text-white">Modifier l'exercice</h3>
                <button onclick="closeEditModal()"
                    class="p-2 bg-gray-200 dark:bg-zinc-800 rounded-full text-zinc-500 hover:text-zinc-900 dark:hover:text-white">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="space-y-4">
                <div><label class="text-xs text-zinc-500 uppercase font-bold ml-1 mb-1 block">Nom</label><input
                        type="text" id="edit-name"
                        class="w-full bg-gray-100 dark:bg-zinc-950 border border-gray-200 dark:border-zinc-800 text-zinc-900 dark:text-white rounded-xl px-4 py-3 focus:outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500 transition-all">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs text-zinc-500 uppercase font-bold ml-1 mb-1 block">Séries</label><input
                            type="number" id="edit-sets"
                            class="w-full bg-gray-100 dark:bg-zinc-950 border border-gray-200 dark:border-zinc-800 text-zinc-900 dark:text-white rounded-xl px-4 py-3 text-center font-bold">
                    </div>
                    <div><label class="text-xs text-zinc-500 uppercase font-bold ml-1 mb-1 block">Reps</label><input
                            type="text" id="edit-reps"
                            class="w-full bg-gray-100 dark:bg-zinc-950 border border-gray-200 dark:border-zinc-800 text-zinc-900 dark:text-white rounded-xl px-4 py-3 text-center">
                    </div>
                </div>
                <div><label class="text-xs text-zinc-500 uppercase font-bold ml-1 mb-1 block">Repos (sec)</label><input
                        type="number" id="edit-rest"
                        class="w-full bg-gray-100 dark:bg-zinc-950 border border-gray-200 dark:border-zinc-800 text-zinc-900 dark:text-white rounded-xl px-4 py-3 text-center">
                </div>
                <div><label class="text-xs text-zinc-500 uppercase font-bold ml-1 mb-1 block">Focus
                        Musculaire</label><input type="text" id="edit-focus"
                        class="w-full bg-gray-100 dark:bg-zinc-950 border border-gray-200 dark:border-zinc-800 text-zinc-900 dark:text-white rounded-xl px-4 py-3 text-sm">
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button onclick="deleteCurrentExercise()"
                    class="flex-1 py-3.5 rounded-xl border border-red-500/30 text-red-500 font-semibold hover:bg-red-500/10 transition-colors">Supprimer</button>
                <button onclick="saveExerciseChanges()"
                    class="flex-[2] py-3.5 rounded-xl bg-red-600 text-white font-semibold hover:bg-red-500 shadow-lg shadow-red-900/40 transition-all">Sauvegarder</button>
            </div>
        </div>
    </div>

    <script>
        window.addEventListener('scroll', () => {
            const header = document.getElementById('main-header');
            if (window.scrollY > 20) {
                header.classList.add('header-scrolled', 'py-2');
                header.classList.remove('py-6');
            } else {
                header.classList.remove('header-scrolled', 'py-2');
                header.classList.add('py-6');
            }
        });

        function loadTheme() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }
        function toggleTheme() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.theme = 'light';
            } else {
                document.documentElement.classList.add('dark');
                localStorage.theme = 'dark';
            }
            renderSettings();
        }
        loadTheme();

        const firebaseConfig = {
            apiKey: "AIzaSyB5uqBRZFJRHILeLhYbizGYYfEvEOqTbHc",
            authDomain: "yutoow-fit.firebaseapp.com",
            projectId: "yutoow-fit",
            storageBucket: "yutoow-fit.firebasestorage.app",
            messagingSenderId: "139731145452",
            appId: "1:139731145452:web:9a139e7ec8c8acd42d4bc9"
        };

        let auth = null, db = null, currentUser = null;
        let unsubscribeSnapshot = null;

        try {
            if (typeof firebase !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                auth.onAuthStateChanged(user => {
                    currentUser = user;
                    if (user) setupRealtimeSync();
                    renderProfile();
                    renderSettings();
                });
            }
        } catch (e) { console.error("Firebase init error:", e); }

        const STORAGE_KEY_SESSIONS = 'onair_sessions';
        const STORAGE_KEY_CURRENT_SESSION = 'onair_current_session';
        const STORAGE_KEY_PRS = 'onair_prs';
        const STORAGE_KEY_PROGRAMS = 'onair_programs_v4';
        const STORAGE_KEY_NOTES = 'onair_notes';

        const defaultPrograms = {
            lundi: {
                id: 'lundi', name: "Lundi - PUSH", exercises: [
                    { name: "Développé Couché Barre", focus: "Faisceau claviculaire et sternal", sets: 4, reps: "6-8", rest: 120 },
                    { name: "Développé Incliné Haltères", focus: "Faisceau claviculaire", sets: 3, reps: "8-12", rest: 90 },
                    { name: "PecFly", focus: "Faisceau sternal", sets: 3, reps: "12-15", rest: 60 },
                    { name: "Écarté Couché Haltères", focus: "Faisceau sternal (Isolation)", sets: 3, reps: "10-12", rest: 90 },
                    { name: "Extensions Triceps Nuque Haltère", focus: "Longue portion du triceps", sets: 4, reps: "12-20", rest: 60 },
                    { name: "Extensions Triceps Corde", focus: "Portions médiane et latérale", sets: 3, reps: "12-15", rest: 60 }
                ]
            },
            mardi: {
                id: 'mardi', name: "Mardi - PULL", exercises: [
                    { name: "Tirage Vertical Poulie Neutre", focus: "Grand Dorsal (Largeur)", sets: 4, reps: "8-12", rest: 105 },
                    { name: "Tirage Horizontal Neutre", focus: "Trapèzes, Rhomboïdes (Épaisseur)", sets: 3, reps: "10-12", rest: 90 },
                    { name: "Rowing Machine Unilatéral", focus: "Grand Dorsal (Isolation)", sets: 3, reps: "6-8 / bras", rest: 75 },
                    { name: "Bûcheron Haltère", focus: "Grand Dorsal, Lombaires", sets: 3, reps: "6-8 / bras", rest: 90 },
                    { name: "Curl Marteau", focus: "Brachial (Épaisseur bras)", sets: 3, reps: "8-12", rest: 75 },
                    { name: "Curl Incliné", focus: "Biceps (Longue portion)", sets: 3, reps: "10-12", rest: 75 }
                ]
            },
            mercredi: {
                id: 'mercredi', name: "Mercredi - LEGS", exercises: [
                    { name: "Hack Squat", focus: "Jambes Global", sets: 4, reps: "6-8", rest: 180 },
                    { name: "Presse à cuisses", focus: "Quadriceps", sets: 4, reps: "10-12", rest: 120 },
                    { name: "Leg Curl", focus: "Ischio-jambiers", sets: 3, reps: "12-15", rest: 60 },
                    { name: "Mollets Debout", focus: "Mollets", sets: 4, reps: "15-20", rest: 45 }
                ]
            },
            vendredi: {
                id: 'vendredi', name: "Vendredi - Upper", exercises: [
                    { name: "Développé Militaire", focus: "Épaules", sets: 4, reps: "8-10", rest: 120 },
                    { name: "Dips", focus: "Pecs/Triceps", sets: 3, reps: "Max", rest: 90 },
                    { name: "Tirage Poitrine", focus: "Dos Largeur", sets: 4, reps: "10-12", rest: 90 }
                ]
            },
            samedi: {
                id: 'samedi', name: "Samedi - Lower", exercises: [
                    { name: "Soulevé de Terre Roumain", focus: "Ischios/Fessiers", sets: 4, reps: "8-10", rest: 120 },
                    { name: "Fentes Bulgares", focus: "Fessiers", sets: 3, reps: "10/jambe", rest: 90 },
                    { name: "Leg Extension", focus: "Quadriceps", sets: 3, reps: "15", rest: 60 }
                ]
            }
        };

        let programs = {};
        let currentDay = 'lundi';
        let currentExerciseIndex = 0;
        let sessionData = [];
        let currentSessionId = null;
        let sessionStartTime = null;
        let timerInterval = null;
        let timerTargetTime = null;
        let timerPausedRemaining = 0;
        let isTimerPaused = false;
        let wakeLock = null;

        loadPrograms();
        loadSession();

        async function requestWakeLock() { try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (err) { console.log(err); } }
        function releaseWakeLock() { if (wakeLock) wakeLock.release().then(() => { wakeLock = null; }); }
        function getSessions() { return JSON.parse(localStorage.getItem(STORAGE_KEY_SESSIONS) || '[]'); }
        function getPRs() { return JSON.parse(localStorage.getItem(STORAGE_KEY_PRS) || '{}'); }
        function getNotes() { return JSON.parse(localStorage.getItem(STORAGE_KEY_NOTES) || '{}'); }
        function loadPrograms() {
            const saved = localStorage.getItem(STORAGE_KEY_PROGRAMS);
            if (saved) {
                programs = JSON.parse(saved);
                Object.keys(programs).forEach(key => { if (!programs[key].id) programs[key].id = key; });
            } else {
                programs = defaultPrograms;
                savePrograms();
            }
        }
        function savePrograms() { localStorage.setItem(STORAGE_KEY_PROGRAMS, JSON.stringify(programs)); if (currentUser) saveToCloud(); }

        function loadSession() {
            const savedSession = localStorage.getItem(STORAGE_KEY_CURRENT_SESSION);
            if (!programs[currentDay]) { const keys = Object.keys(programs); currentDay = keys.length > 0 ? keys[0] : 'lundi'; }
            const program = programs[currentDay];
            if (!program.exercises || program.exercises.length === 0) { program.exercises = [{ name: "Nouvel Exercice", focus: "Muscle", sets: 3, reps: "10", rest: 60 }]; savePrograms(); }
            if (savedSession) {
                const state = JSON.parse(savedSession);
                if (state.day === currentDay) { sessionData = state.data || []; currentSessionId = state.id; sessionStartTime = new Date(state.startTime); }
            }
            if (currentExerciseIndex >= program.exercises.length) currentExerciseIndex = 0;
            if (sessionData.length === 0 && !currentSessionId) { currentSessionId = Date.now().toString(); sessionStartTime = new Date(); }
            renderSessionView();
        }

        function renderSessionView() {
            const program = programs[currentDay];
            const exercise = program.exercises[currentExerciseIndex];
            const nextExo = program.exercises[currentExerciseIndex + 1];

            const totalExercises = program.exercises.length;
            const completedSets = sessionData.filter(s => s.exercise === exercise.name).length;
            const dayKeys = Object.keys(programs);

            const getExerciseCardHTML = (exo, isNext = false) => {
                const isCompleted = sessionData.filter(s => s.exercise === exo.name).length;
                return `
                <div class="${isNext ? 'absolute top-0 left-0 w-full h-full z-0 scale-95 blur-sm opacity-60 pointer-events-none' : 'relative z-10'} bg-white dark:bg-zinc-900 border border-gray-200 dark:border-zinc-800 rounded-3xl p-6 shadow-xl overflow-hidden transition-all duration-300 exercise-card origin-bottom" ${isNext ? 'id="next-card"' : 'id="active-card"'}>
                    <div class="mb-6 text-zinc-500 dark:text-zinc-400 text-sm italic border-l-2 border-red-500 pl-3">${exo.focus || 'Pas de focus'}</div>
                    <div class="grid grid-cols-2 gap-6 mb-8 relative z-10">
                        <div class="bg-gray-50 dark:bg-zinc-950/50 rounded-2xl p-4 border border-gray-100 dark:border-zinc-800"><div class="text-zinc-500 text-xs uppercase font-bold mb-1">Séries</div><div class="text-3xl font-bold text-zinc-900 dark:text-white">${isCompleted}<span class="text-zinc-400 text-xl">/${exo.sets}</span></div></div>
                        <div class="bg-gray-50 dark:bg-zinc-950/50 rounded-2xl p-4 border border-gray-100 dark:border-zinc-800"><div class="text-zinc-500 text-xs uppercase font-bold mb-1">Objectif</div><div class="text-3xl font-bold text-zinc-900 dark:text-white">${exo.reps}</div></div>
                    </div>
                    ${!isNext ? `
                    <div class="space-y-6 relative z-10">
                        <div class="flex gap-6">
                            <div class="flex-1"><label class="text-xs text-zinc-400 font-bold ml-1 mb-2 block">CHARGE (KG)</label><div class="relative"><input type="number" id="weight-input" placeholder="0" class="w-full bg-gray-100 dark:bg-zinc-950 border border-gray-200 dark:border-zinc-700 rounded-2xl py-4 text-center text-2xl font-bold text-zinc-900 dark:text-white focus:border-red-500 focus:ring-1 focus:ring-red-500 transition-all placeholder-zinc-400 dark:placeholder-zinc-700 outline-none"></div></div>
                            <div class="flex-1"><label class="text-xs text-zinc-400 font-bold ml-1 mb-2 block">RÉPÉTITIONS</label><div class="relative"><input type="number" id="reps-input" placeholder="0" class="w-full bg-gray-100 dark:bg-zinc-950 border border-gray-200 dark:border-zinc-700 rounded-2xl py-4 text-center text-2xl font-bold text-zinc-900 dark:text-white focus:border-red-500 focus:ring-1 focus:ring-red-500 transition-all placeholder-zinc-400 dark:placeholder-zinc-700 outline-none"></div></div>
                        </div>
                        <button onclick="logSet()" class="w-full bg-zinc-900 dark:bg-white text-white dark:text-black font-bold text-lg py-4 rounded-2xl hover:opacity-90 active:scale-[0.98] transition-all flex items-center justify-center gap-2 shadow-lg shadow-black/10"><span>Valider la Série</span><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/></svg></button>
                    </div>` : '<div class="h-32 flex items-center justify-center text-zinc-400">Prochain exercice...</div>'}
                </div>`;
            };

            const html = `
                <div class="flex gap-3 overflow-x-auto pb-4 no-scrollbar -mx-4 px-4 snap-x">
                    ${dayKeys.map((key, i) => {
                const prog = programs[key];
                const isActive = currentDay === key;
                const shortName = prog.name.split(' ')[0].substring(0, 3);
                return `<button onclick="changeDay('${key}')" class="snap-center shrink-0 flex flex-col items-center justify-center w-16 h-20 rounded-2xl border transition-all duration-300 ${isActive ? 'bg-red-600 border-red-500 shadow-lg shadow-red-900/40 translate-y-1 text-white' : 'bg-white dark:bg-zinc-900 border-gray-200 dark:border-zinc-800 text-zinc-500 hover:border-zinc-400'}"><span class="text-[10px] uppercase font-bold tracking-wider opacity-80">${shortName}</span><span class="text-xl font-bold mt-1">${i + 1}</span></button>`;
            }).join('')}
                    <button onclick="addNewDay()" class="snap-center shrink-0 w-16 h-20 rounded-2xl border border-dashed border-gray-300 dark:border-zinc-800 flex items-center justify-center text-zinc-400 hover:text-red-500 transition-colors"><svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg></button>
                </div>
                
                <div id="swipe-area" class="relative group perspective-1000 min-h-[450px]">
                    <div class="flex justify-between items-end mb-5 px-1 relative z-20">
                        <div><span class="text-xs text-red-600 dark:text-red-500 font-bold uppercase tracking-wider">Exercice ${currentExerciseIndex + 1} / ${totalExercises}</span><h2 class="text-2xl font-bold text-zinc-900 dark:text-white leading-tight mt-1">${exercise.name}</h2></div>
                        <button onclick="openEditModal()" class="p-2 text-zinc-400 hover:text-zinc-900 dark:hover:text-white transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg></button>
                    </div>

                    <!-- CARD STACK CONTAINER -->
                    <div id="cards-stack" class="relative w-full">
                        ${nextExo ? getExerciseCardHTML(nextExo, true) : ''}
                        ${getExerciseCardHTML(exercise, false)}
                    </div>

                    <div class="flex justify-between items-center px-4 mt-3 text-zinc-400 dark:text-zinc-500 text-xs font-medium relative z-20">
                        <button onclick="prevExercise()" class="flex items-center gap-1 hover:text-zinc-900 dark:hover:text-white p-2 ${currentExerciseIndex === 0 ? 'opacity-0 pointer-events-none' : ''}"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>Précédent</button>
                        <span>Swipe pour naviguer</span>
                        <button onclick="nextExercise()" class="flex items-center gap-1 hover:text-zinc-900 dark:hover:text-white p-2 ${currentExerciseIndex === totalExercises - 1 ? 'opacity-0 pointer-events-none' : ''}">Suivant<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button>
                    </div>
                </div>

                <div class="mt-6 mx-1 animate-slide-up">
                    <label class="text-xs text-zinc-400 font-bold uppercase tracking-wider ml-1 mb-2 block flex items-center gap-2">
                       <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                       Notes & Réglages
                    </label>
                    <textarea oninput="saveCurrentNote(this.value)" class="w-full bg-white dark:bg-zinc-900 border border-gray-200 dark:border-zinc-800 rounded-2xl p-4 text-sm focus:border-red-500 focus:ring-1 focus:ring-red-500 outline-none resize-none h-24 shadow-sm transition-all text-zinc-800 dark:text-zinc-200 placeholder-zinc-400" placeholder="Ex: Siège au cran 4, attention épaule gauche...">${getNotes()[exercise.name] || ''}</textarea>
                </div>

                ${completedSets > 0 ? `<div class="mt-6 animate-slide-up"><h3 class="text-sm font-bold text-zinc-400 uppercase tracking-wider mb-3 px-1">Aujourd'hui</h3><div class="space-y-2">${sessionData.filter(s => s.exercise === exercise.name).map((set, i) => `<div class="flex items-center justify-between bg-white dark:bg-zinc-900 border border-gray-100 dark:border-zinc-800 rounded-xl p-4 shadow-sm"><div class="flex items-center gap-3"><div class="w-6 h-6 rounded-full bg-red-100 dark:bg-red-500/10 text-red-600 dark:text-red-500 flex items-center justify-center text-xs font-bold">${i + 1}</div><span class="text-zinc-500 dark:text-zinc-400 text-sm">Série terminée</span></div><span class="text-zinc-900 dark:text-white font-bold font-mono text-lg">${set.weight}<span class="text-sm text-zinc-400 font-sans ml-1">kg</span> <span class="mx-1 text-zinc-300">×</span> ${set.reps}</span></div>`).join('')}</div></div>` : ''}
                <div class="h-8"></div>
            `;
            document.getElementById('session-view').innerHTML = html;
            const swipeArea = document.getElementById('swipe-area');
            if (swipeArea) {
                // Remove old listeners if any (though DOM replacement handles this, explicit removal is cleaner if we kept references)
                swipeArea.removeEventListener('touchstart', handleTouchStart);
                swipeArea.removeEventListener('touchmove', handleTouchMove);
                swipeArea.removeEventListener('touchend', handleTouchEnd);

                swipeArea.addEventListener('touchstart', handleTouchStart, { passive: true });
                swipeArea.addEventListener('touchmove', handleTouchMove, { passive: false });
                swipeArea.addEventListener('touchend', handleTouchEnd, { passive: true });
            }
            setTimeout(() => { const prs = getPRs(); if (prs[exercise.name]) { const weightInput = document.getElementById('weight-input'); if (weightInput) weightInput.value = prs[exercise.name].weight; } }, 50);
        }


        // --- SWIPE LOGIC IMPROVED ---
        let touchStartX = 0;
        let touchCurrentX = 0;
        let isSwiping = false;
        let autoAdvanceTimer = null;

        function handleTouchStart(e) {
            if (autoAdvanceTimer) { clearTimeout(autoAdvanceTimer); autoAdvanceTimer = null; } // Cancel auto-advance if user interacts
            touchStartX = e.touches[0].clientX;
            isSwiping = true;
            const activeCard = document.getElementById('active-card');
            const nextCard = document.getElementById('next-card');
            if (activeCard) activeCard.style.transition = 'none';
            if (nextCard) nextCard.style.transition = 'none';
        }

        function handleTouchMove(e) {
            if (!isSwiping) return;
            touchCurrentX = e.touches[0].clientX;
            const diff = touchCurrentX - touchStartX;

            // Only handle significant horizontal swipes to avoid blocking scroll too easily
            if (Math.abs(diff) < 5) return;
            if (e.cancelable) e.preventDefault();

            const activeCard = document.getElementById('active-card');
            const nextCard = document.getElementById('next-card');

            if (activeCard) {
                // Active Card Movement
                const rotation = diff / 25;
                activeCard.style.transform = `translateX(${diff}px) rotate(${rotation}deg)`;

                // Next Card Animation (Progressive unblur & scale)
                if (nextCard && diff < 0) { // Only if swiping LEFT (Forward)
                    // Calculate progress 0 to 1 based on screen width ~factor
                    const progress = Math.min(Math.abs(diff) / 250, 1);

                    // Scale: 0.95 -> 1
                    const scale = 0.95 + (0.05 * progress);
                    // Blur: 4px -> 0px
                    const blur = 4 - (4 * progress);
                    // Opacity: 0.6 -> 1
                    const opacity = 0.6 + (0.4 * progress);

                    nextCard.style.transform = `scale(${scale})`;
                    nextCard.style.filter = `blur(${blur}px)`;
                    nextCard.style.opacity = `${opacity}`;
                }
            }
        }

        function handleTouchEnd(e) {
            if (!isSwiping) return;
            isSwiping = false;
            const diff = touchCurrentX - touchStartX;
            const threshold = 120; // Slightly higher threshold

            const activeCard = document.getElementById('active-card');
            const nextCard = document.getElementById('next-card');

            if (!activeCard) return;

            // Restore transitions
            activeCard.style.transition = 'transform 0.4s cubic-bezier(0.16, 1, 0.3, 1)'; // iOS smooth curve
            if (nextCard) nextCard.style.transition = 'all 0.4s cubic-bezier(0.16, 1, 0.3, 1)';

            if (Math.abs(diff) > threshold) {
                // Swipe Validated
                const endX = diff > 0 ? window.innerWidth : -window.innerWidth;
                const endRot = diff / 15;

                activeCard.style.transform = `translateX(${endX}px) rotate(${endRot}deg)`;

                // If moving next, finalize the next card state
                if (diff < 0 && nextCard) {
                    nextCard.style.transform = 'scale(1)';
                    nextCard.style.filter = 'blur(0px)';
                    nextCard.style.opacity = '1';
                }

                setTimeout(() => {
                    if (diff > 0) prevExercise();
                    else nextExercise();
                }, 300);
            } else {
                // Cancelled - Revert
                activeCard.style.transform = 'translateX(0) rotate(0)';
                if (nextCard) {
                    nextCard.style.transform = 'scale(0.95)';
                    nextCard.style.filter = 'blur(4px)';
                    nextCard.style.opacity = '0.6';
                }
            }
            touchStartX = 0;
            touchCurrentX = 0;
        }

        function prevExercise() {
            if (currentExerciseIndex > 0) {
                currentExerciseIndex--;
                loadSession();
            }
        }
        function nextExercise() {
            if (currentExerciseIndex < programs[currentDay].exercises.length - 1) {
                currentExerciseIndex++;
                loadSession();
            }
        }
        function changeDay(day) { currentDay = day; currentExerciseIndex = 0; loadSession(); }

        function logSet() {
            const weightInput = document.getElementById('weight-input');
            const repsInput = document.getElementById('reps-input');
            const weight = parseFloat(weightInput.value);
            const reps = parseInt(repsInput.value);
            if (!weight && weight !== 0 || !reps) { weightInput.parentElement.classList.add('animate-pulse'); setTimeout(() => weightInput.parentElement.classList.remove('animate-pulse'), 500); return; }
            const exercise = programs[currentDay].exercises[currentExerciseIndex];
            sessionData.push({ sessionId: currentSessionId, day: currentDay, programName: programs[currentDay].name, exercise: exercise.name, weight, reps, timestamp: new Date().toISOString() });
            localStorage.setItem(STORAGE_KEY_CURRENT_SESSION, JSON.stringify({ id: currentSessionId, startTime: sessionStartTime, data: sessionData, day: currentDay }));
            if (currentUser) saveToCloud();
            updatePR(exercise.name, weight, reps);
            repsInput.value = '';

            // Auto swipe animation on validation (optional, can be kept simple)
            const completedSets = sessionData.filter(s => s.exercise === exercise.name).length;
            if (completedSets >= exercise.sets) {
                if (currentExerciseIndex < programs[currentDay].exercises.length - 1) {
                    // Simulate swipe next for consistency
                    const activeCard = document.getElementById('active-card');
                    if (activeCard) {
                        activeCard.style.transition = 'transform 0.4s ease';
                        activeCard.style.transform = 'translateX(-100vw) rotate(-10deg)';
                    }
                    if (autoAdvanceTimer) clearTimeout(autoAdvanceTimer);
                    autoAdvanceTimer = setTimeout(() => { currentExerciseIndex++; loadSession(); }, 300);
                } else {
                    showSessionComplete();
                }
            } else {
                renderSessionView();
            }
            startRestTimer(exercise.rest);
        }

        function startRestTimer(seconds) {
            const timerEl = document.getElementById('rest-timer'); timerEl.classList.remove('hidden'); timerEl.classList.add('flex');
            timerTargetTime = Date.now() + (seconds * 1000); isTimerPaused = false;
            updateTimerDisplay(); requestWakeLock();
            if (timerInterval) clearInterval(timerInterval); timerInterval = setInterval(timerLoop, 100);
        }
        function timerLoop() { if (isTimerPaused) return; const now = Date.now(); const diff = Math.ceil((timerTargetTime - now) / 1000); if (diff <= 0) stopRestTimer(true); else updateTimerDisplay(diff); }
        function updateTimerDisplay(forceValue) {
            let val; if (typeof forceValue === 'number') val = forceValue; else if (isTimerPaused) val = timerPausedRemaining; else val = Math.max(0, Math.ceil((timerTargetTime - Date.now()) / 1000));
            const mins = Math.floor(val / 60); const secs = val % 60;
            document.getElementById('timer-display').textContent = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }
        function toggleTimer() {
            isTimerPaused = !isTimerPaused;
            document.getElementById('timer-icon-pause').classList.toggle('hidden', isTimerPaused); document.getElementById('timer-icon-play').classList.toggle('hidden', !isTimerPaused);
            if (isTimerPaused) { timerPausedRemaining = Math.max(0, Math.ceil((timerTargetTime - Date.now()) / 1000)); releaseWakeLock(); } else { timerTargetTime = Date.now() + (timerPausedRemaining * 1000); requestWakeLock(); }
        }
        function adjustTimer(sec) { if (isTimerPaused) { timerPausedRemaining = Math.max(0, timerPausedRemaining + sec); updateTimerDisplay(timerPausedRemaining); } else { timerTargetTime += (sec * 1000); if (timerTargetTime <= Date.now()) stopRestTimer(true); else updateTimerDisplay(); } }
        function stopRestTimer(finished = false) { clearInterval(timerInterval); document.getElementById('rest-timer').classList.add('hidden'); document.getElementById('rest-timer').classList.remove('flex'); releaseWakeLock(); if (finished) { if ("vibrate" in navigator) navigator.vibrate([200, 100, 200]); } }

        function switchView(view) {
            ['session', 'profile', 'settings', 'auth'].forEach(v => { document.getElementById(`${v}-view`).classList.add('hidden'); document.getElementById(`nav-${v}`)?.classList.remove('active'); });
            const target = document.getElementById(`${view}-view`); target.classList.remove('hidden'); target.classList.remove('animate-slide-up'); void target.offsetWidth; target.classList.add('animate-slide-up');
            document.getElementById(`nav-${view}`)?.classList.add('active');
            if (view === 'profile') renderProfile(); if (view === 'settings') renderSettings(); if (view === 'auth') renderAuth();
            window.scrollTo(0, 0);
        }

        function updatePR(exerciseName, weight, reps) {
            const prs = getPRs(); const currentPR = prs[exerciseName] || { weight: 0, reps: 0 };
            if (weight > currentPR.weight || (weight === currentPR.weight && reps > currentPR.reps)) { prs[exerciseName] = { weight, reps, date: new Date().toISOString() }; localStorage.setItem(STORAGE_KEY_PRS, JSON.stringify(prs)); return true; } return false;
        }

        function saveToCloud(force = false) { if (!currentUser || !db) return; db.collection('users').doc(currentUser.uid).set({ programs: JSON.stringify(programs), sessions: localStorage.getItem(STORAGE_KEY_SESSIONS) || "[]", prs: localStorage.getItem(STORAGE_KEY_PRS) || "{}", notes: localStorage.getItem(STORAGE_KEY_NOTES) || "{}", lastUpdate: new Date().toISOString() }, { merge: true }); }

        function saveCurrentNote(val) {
            const exercise = programs[currentDay].exercises[currentExerciseIndex];
            const notes = getNotes();
            notes[exercise.name] = val;
            localStorage.setItem(STORAGE_KEY_NOTES, JSON.stringify(notes));
            if (currentUser) saveToCloud();
        }

        function openEditModal() { const ex = programs[currentDay].exercises[currentExerciseIndex]; document.getElementById('edit-name').value = ex.name; document.getElementById('edit-sets').value = ex.sets; document.getElementById('edit-reps').value = ex.reps; document.getElementById('edit-rest').value = ex.rest; document.getElementById('edit-focus').value = ex.focus || ""; document.getElementById('edit-modal').classList.remove('hidden'); document.getElementById('edit-modal').classList.add('flex'); }
        function closeEditModal() { document.getElementById('edit-modal').classList.add('hidden'); document.getElementById('edit-modal').classList.remove('flex'); }
        function saveExerciseChanges() { const name = document.getElementById('edit-name').value; const sets = parseInt(document.getElementById('edit-sets').value); const reps = document.getElementById('edit-reps').value; const rest = parseInt(document.getElementById('edit-rest').value); const focus = document.getElementById('edit-focus').value; if (!name || !sets || !reps) return; programs[currentDay].exercises[currentExerciseIndex] = { name, sets, reps, rest, focus }; savePrograms(); closeEditModal(); loadSession(); }
        function deleteCurrentExercise() { if (!confirm("Supprimer l'exercice ?")) return; programs[currentDay].exercises.splice(currentExerciseIndex, 1); savePrograms(); closeEditModal(); if (currentExerciseIndex >= programs[currentDay].exercises.length) { currentExerciseIndex = Math.max(0, programs[currentDay].exercises.length - 1); } loadSession(); }
        function addNewDay() { const id = prompt("ID (ex: dimanche)"); if (!id) return; const safeId = id.toLowerCase().trim(); programs[safeId] = { id: safeId, name: id, exercises: [{ name: "Nouvel Exo", sets: 3, reps: "10", rest: 60 }] }; savePrograms(); changeDay(safeId); }

        function renderProfile() {
            const sessions = getSessions().sort((a, b) => new Date(b.startTime) - new Date(a.startTime)); const prs = getPRs();
            let html = `<div class="glass-panel rounded-3xl p-6 shadow-sm"><h2 class="text-2xl font-bold mb-4 text-zinc-900 dark:text-white">Profil</h2>${currentUser ? `<div class="flex items-center gap-4 bg-gray-100 dark:bg-zinc-900 p-4 rounded-2xl"><div class="w-10 h-10 rounded-full bg-green-100 dark:bg-green-500/20 text-green-600 dark:text-green-500 flex items-center justify-center">✓</div><div><p class="text-sm text-zinc-500 dark:text-zinc-400">Compte actif</p><p class="font-bold text-zinc-900 dark:text-white">${currentUser.email}</p></div></div>` : `<button onclick="switchView('auth')" class="w-full bg-red-600 py-3 rounded-xl font-bold text-white hover:bg-red-500 transition-colors">Se connecter</button><p class="text-xs text-zinc-500 mt-2 text-center">Sauvegardez vos données dans le cloud</p>`}</div><div class="space-y-4"><h3 class="font-bold text-lg px-2 text-zinc-900 dark:text-white">Records (PRs)</h3><div class="grid grid-cols-2 gap-3">${Object.entries(prs).map(([name, data]) => `<div class="bg-white dark:bg-zinc-900 border border-gray-100 dark:border-zinc-800 p-4 rounded-2xl shadow-sm"><p class="text-xs text-zinc-500 truncate mb-1">${name}</p><p class="text-xl font-bold text-zinc-900 dark:text-white">${data.weight} <span class="text-sm text-zinc-400 dark:text-zinc-600">kg</span></p></div>`).join('')}</div></div><div class="space-y-3 pb-20"><h3 class="font-bold text-lg px-2 text-zinc-900 dark:text-white">Historique</h3>${sessions.map(s => { const date = new Date(s.startTime).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' }); return `<div class="bg-white dark:bg-zinc-900 border border-gray-100 dark:border-zinc-800 p-4 rounded-2xl flex justify-between items-center shadow-sm"><div><p class="font-bold text-zinc-900 dark:text-white">${s.programName}</p><p class="text-xs text-zinc-500">${date} • ${s.totalSets || 0} séries</p></div><div class="text-zinc-400">→</div></div>` }).join('')}</div>`;
            document.getElementById('profile-view').innerHTML = html;
        }

        function renderSettings() {
            const isDark = document.documentElement.classList.contains('dark');
            document.getElementById('settings-view').innerHTML = `
                <div class="glass-panel rounded-3xl p-6 shadow-sm space-y-4">
                    <h2 class="text-2xl font-bold text-zinc-900 dark:text-white">Paramètres</h2>
                    <button onclick="toggleTheme()" class="w-full flex justify-between items-center p-4 bg-gray-100 dark:bg-zinc-900 rounded-xl text-zinc-900 dark:text-white">
                        <span>Mode Sombre</span>
                        <div class="w-12 h-6 bg-zinc-300 dark:bg-zinc-700 rounded-full relative transition-colors">
                            <div class="w-5 h-5 bg-white rounded-full absolute top-0.5 transition-all ${isDark ? 'left-[1.6rem]' : 'left-0.5'} shadow-sm"></div>
                        </div>
                    </button>
                    
                    <div class="pt-6 border-t border-gray-200 dark:border-zinc-800 space-y-3">
                        <button onclick="clearUserData()" class="w-full py-4 bg-red-500/10 border border-red-500/20 text-red-600 dark:text-red-500 font-bold hover:bg-red-500/20 text-sm rounded-xl transition-all flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            Supprimer Stats & Records
                        </button>
                        
                        <button onclick="if(confirm('Réinitialiser toute l\\'application ? Cela effacera aussi vos programmes personnalisés.')){localStorage.clear(); location.reload();}" class="w-full py-3 text-zinc-400 hover:text-zinc-600 dark:hover:text-white font-medium text-xs transition-colors">
                            Réinitialisation d'usine (Tout effacer)
                        </button>
                    </div>
                </div>
             `;
        }

        async function clearUserData() {
            if (!confirm("Êtes-vous sûr de vouloir supprimer tout l'historique et les records personnels ?\n\nCette action est définitive.")) return;
            localStorage.removeItem(STORAGE_KEY_SESSIONS);
            localStorage.removeItem(STORAGE_KEY_PRS);
            sessionData = [];
            if (currentUser && db) {
                try {
                    await db.collection('users').doc(currentUser.uid).set({
                        sessions: "[]",
                        prs: "{}"
                    }, { merge: true });
                } catch (e) {
                    console.error("Erreur suppression cloud:", e);
                }
            }
            alert("Historique et records effacés.");
            location.reload();
        }

        function renderAuth() {
            document.getElementById('auth-view').innerHTML = `<div class="glass-panel rounded-3xl p-8 shadow-xl mt-10"><h2 class="text-2xl font-bold mb-6 text-center text-zinc-900 dark:text-white">Connexion</h2><div class="space-y-4"><input type="email" id="auth-email" placeholder="Email" class="w-full bg-gray-100 dark:bg-zinc-950 border border-gray-200 dark:border-zinc-800 text-zinc-900 dark:text-white rounded-xl px-4 py-3 focus:border-red-500 outline-none transition-colors"><input type="password" id="auth-password" placeholder="Mot de passe" class="w-full bg-gray-100 dark:bg-zinc-950 border border-gray-200 dark:border-zinc-800 text-zinc-900 dark:text-white rounded-xl px-4 py-3 focus:border-red-500 outline-none transition-colors"></div><div class="grid grid-cols-2 gap-3 mt-6"><button onclick="handleLogin()" class="bg-gray-200 dark:bg-zinc-800 text-zinc-900 dark:text-white hover:bg-gray-300 dark:hover:bg-zinc-700 py-3 rounded-xl font-bold transition-colors">Connexion</button><button onclick="handleSignup()" class="bg-red-600 text-white hover:bg-red-500 py-3 rounded-xl font-bold transition-colors">Créer</button></div><p id="auth-error" class="text-red-500 text-sm text-center mt-4 hidden"></p></div>`;
        }

        async function handleLogin() { try { await auth.signInWithEmailAndPassword(document.getElementById('auth-email').value, document.getElementById('auth-password').value); switchView('profile'); } catch (e) { document.getElementById('auth-error').textContent = e.message; document.getElementById('auth-error').classList.remove('hidden'); } }
        async function handleSignup() { try { await auth.createUserWithEmailAndPassword(document.getElementById('auth-email').value, document.getElementById('auth-password').value); switchView('profile'); } catch (e) { document.getElementById('auth-error').textContent = e.message; document.getElementById('auth-error').classList.remove('hidden'); } }

        function setupRealtimeSync() {
            if (!currentUser || !db) return;
            if (unsubscribeSnapshot) unsubscribeSnapshot();
            unsubscribeSnapshot = db.collection('users').doc(currentUser.uid).onSnapshot(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    if (data.programs) {
                        programs = JSON.parse(data.programs);
                        localStorage.setItem(STORAGE_KEY_PROGRAMS, data.programs);
                    }
                    if (data.notes) {
                        const localNotes = localStorage.getItem(STORAGE_KEY_NOTES);
                        if (data.notes !== localNotes) {
                            localStorage.setItem(STORAGE_KEY_NOTES, data.notes);
                            // Optional: Update view if session view is active? 
                            // Easier to just let next load handle it, or force reload if active.
                        }
                    }
                }
            });
        }

        function showSessionComplete() {
            const summary = generateSessionSummary();
            document.getElementById('session-view').innerHTML = `
                <div class="glass-panel rounded-3xl p-8 text-center animate-slide-up mt-10">
                    <div class="text-6xl mb-4">🔥</div>
                    <h2 class="text-3xl font-bold mb-2 text-zinc-900 dark:text-white">Séance Terminée !</h2>
                    <p class="text-zinc-500 dark:text-zinc-400 mb-8">Bravo, tu as tué la séance.</p>
                    
                    <div class="space-y-3 mb-8">
                         <button onclick="shareSessionReport()" class="w-full bg-red-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-red-900/30 hover:bg-red-500 transition-all flex items-center justify-center gap-2">
                             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
                             Partager / Copier
                         </button>
                         
                         <button onclick="currentExerciseIndex=0; sessionData=[]; loadSession()" class="w-full bg-zinc-100 dark:bg-zinc-800 text-zinc-900 dark:text-white font-bold py-4 rounded-xl hover:bg-zinc-200 dark:hover:bg-zinc-700 transition-all">
                             Nouvelle Séance
                         </button>
                    </div>
                    <p class="text-xs text-zinc-400">Le résumé est prêt à être partagé.</p>
                </div>
            `;
        }

        function generateSessionSummary() {
            const program = programs[currentDay];
            const date = new Date().toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
            let text = `🔥 Séance ${program.name} - ${date}\n\n`;

            // Group by exercise
            const grouped = {};
            sessionData.forEach(set => {
                if (!grouped[set.exercise]) grouped[set.exercise] = [];
                grouped[set.exercise].push(set);
            });

            Object.keys(grouped).forEach(exoName => {
                text += `📌 ${exoName}\n`;
                const sets = grouped[exoName];
                sets.forEach((set, i) => {
                    text += `   • Série ${i + 1}: ${set.weight}kg x ${set.reps}\n`;
                });
                const note = getNotes()[exoName];
                if (note) text += `   📝 Note: ${note}\n`;
                text += '\n';
            });

            text += `🚀 Suivi via YFitracker`;
            return text;
        }

        async function shareSessionReport() {
            const text = generateSessionSummary();
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Résumé Séance YFitracker',
                        text: text
                    });
                } catch (err) {
                    console.log('Partage annulé ou échoué:', err);
                    copyToClipboard(text);
                }
            } else {
                copyToClipboard(text);
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert("Résumé copié dans le presse-papier !");
            }).catch(err => {
                console.error('Erreur copie:', err);
                alert("Impossible de copier automatiquement.");
            });
        }
    </script>
</body>

</html>